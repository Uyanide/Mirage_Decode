import{r as f,s as M,a as _,j as n,B as i,L as H,b as L,u as c,c as S,d as $,e as N,f as C,g as G,T as P,D as I,E,m as A,h as B}from"./index-CGfsbu-D.js";import{P as z,I as U,D as q,L as k,a as w,b as J,n as R,C as K,c as V,H as W,S as O,N as F,d as Q,M as j,F as X}from"./number-input-BFXS09dJ.js";function Y({onLoad:s,children:t,defaultImage:e,disabled:r}){const[a,h]=f.useState(!1),u=f.useCallback(o=>{(async()=>{h(!0);const m=await o();if(m.length===0){M("没有图片被加载");return}const l=m.map(p=>new Promise(D=>{z.fromFileData(p).then(v=>{D(v)}).catch(v=>{console.error("Failed to load image:",v),D(null)})})),g=(await Promise.all(l)).filter(p=>p!==null);g.length!==0&&(_(`成功加载 ${g.length.toString()} 张图片`),s(g))})().catch(m=>{console.error("Failed to load image:",m),M("加载图片失败")}).finally(()=>{h(!1)})},[s]),d=()=>k.fromFileSelect(!0),x=o=>k.fromDropItems(o,!0);return n.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:1,width:"100%"},children:[a&&n.jsx(H,{}),n.jsxs(i,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",gap:1,width:"100%"},children:[n.jsx(i,{sx:{flex:1},children:n.jsx(U,{onconfirm:o=>{s([o])},label:"加载单张",disabled:a||r,defaultImage:e})}),n.jsx(i,{sx:{flex:1},children:n.jsx(L,{variant:"contained",color:"secondary",onClick:()=>{u(d)},fullWidth:!0,disabled:a||r,children:"加载多张"})})]}),n.jsx(q,{onDrop:o=>{u(()=>x(o))},disabled:a||r,children:t})]})}const b={black:(s,t,e)=>{s[e]=0,s[e+1]=0,s[e+2]=0,s[e+3]=255},white:(s,t,e)=>{s[e]=255,s[e+1]=255,s[e+2]=255,s[e+3]=255},transparent:(s,t,e)=>{s[e]=0,s[e+1]=0,s[e+2]=0,s[e+3]=0},lcopy:(s,t,e)=>{if(e/4%t===0){b.black(s,t,e);return}s[e]=s[e-4],s[e+1]=s[e-3],s[e+2]=s[e-2],s[e+3]=s[e-1]},tcopy:(s,t,e)=>{const r=e-t*4;if(r<0){b.black(s,t,e);return}s[e]=s[r],s[e+1]=s[r+1],s[e+2]=s[r+2],s[e+3]=s[r+3]},ltavg:(s,t,e)=>{if(!e){b.black(s,t,e);return}const r=e-t*4;if(r<0){b.lcopy(s,t,e);return}if(e/4%t===0){b.tcopy(s,t,e);return}const a=e-4,h=e-t*4-4,u=(s[a]+s[r]+s[h])/3,d=(s[a+1]+s[r+1]+s[h+1])/3,x=(s[a+2]+s[r+2]+s[h+2])/3,o=(s[a+3]+s[r+3]+s[h+3])/3;s[e]=u,s[e+1]=d,s[e+2]=x,s[e+3]=o}};function Z(s,t,{lowerThreshold:e,higherThreshold:r,method:a,grayConvert:h}){const u=s.data,d=t.data;if(r<=e){for(let l=0;l<d.length;l+=4)d[l]=0,d[l+1]=0,d[l+2]=0,d[l+3]=u[l+3];return}const x=255/(r-e),o=l=>Math.max(Math.min((l-e)*x,255),0),m=b[a];for(let l=0;l<u.length;l+=4){const y=u[l],g=u[l+1],p=u[l+2],D=(h??w.toGrayLum)(y,g,p),v=u[l+3];D>=e&&D<=r?(d[l]=o(y),d[l+1]=o(g),d[l+2]=o(p),d[l+3]=v):m(d,s.width,l)}}function ee(s,t){if(s.length<0)return!1;const e=s[0]==="1";if(s.length<3)return;const r=parseInt(s.slice(1,3),16);if(isNaN(r)||(e?(t.lowerThreshold=255-r,t.higherThreshold=255):(t.lowerThreshold=0,t.higherThreshold=r),s.length<5))return;const a=parseInt(s.slice(3,5),16);isNaN(a)||a<0||a>100||(t.contrast=w.scaleContrastExpand(100-a))}class se extends J{decodedData=R();adjustedData=R();bind(t){super.bind(t),this.subscribe(c.subscribe(e=>e.lowerThreshold,()=>{this.decode()})),this.subscribe(c.subscribe(e=>e.higherThreshold,()=>{this.decode()})),this.subscribe(c.subscribe(e=>e.method,()=>{this.decode()})),this.subscribe(c.subscribe(e=>e.contrast,()=>{this.adjust(!0)})),this.subscribe(S.subscribe(e=>e.currImage,e=>{e?this.setImage(e.image):this.clearImage()},{fireImmediately:!0}))}setImage(t){super.setImage(t,!1),this.setPreset(t.metadata),this.decode(),this.adjust(),this.putImageData(this.adjustedData)}clearImage(){this.srcData.v=null,this.decodedData.v=null,this.adjustedData.v=null,this.clear()}setPreset(t){console.log("Setting preset from string:",t);const{lowerThreshold:e,higherThreshold:r,contrast:a}=c.getState(),h={lowerThreshold:e,higherThreshold:r,method:"black",contrast:a};ee(t,h),this.setValues(h)}setValues(t){c.setState({lowerThreshold:t.lowerThreshold,higherThreshold:t.higherThreshold,contrast:t.contrast})}decode=()=>{if(!this.srcData.v){console.warn("No original image data to decode");return}if(w.matchSize(this.srcData,this.decodedData),!this.decodedData.v){console.warn("No buffer available");return}const{lowerThreshold:t,higherThreshold:e,method:r,contrast:a}=c.getState();Z(this.srcData.v,this.decodedData.v,{lowerThreshold:t,higherThreshold:e,method:r}),this.adjust()};adjust(t){const{contrast:e}=c.getState();t||e!==0?w.adjustContrast(e,this.decodedData,this.adjustedData):this.adjustedData.v=this.decodedData.v,this.putImageData(this.adjustedData)}async saveCurrentImage(t){return this.saveImageFile(await this.encodeImageFile(this.adjustedData,t),t)}async saveOriginalImage(t){return this.saveImageFile(await this.encodeImageFile(this.srcData,t),t)}}const T=new se;function ie(){const[s,t]=f.useState(!1),e=S(o=>o.setImages),r=$(o=>o.setShow),a=f.useCallback(o=>{e(o),o.length>1&&r(!0)},[e,r]),h=f.useCallback(()=>{t(!0),(async()=>{const o=await k.fromAssets(N.decode);if(o.length===0){C("加载默认图片失败");return}const m=await z.fromFileData(o[0]);e([m])})().catch(o=>{C("加载默认图片失败"),console.error("Failed to load default image:",o)}).finally(()=>{t(!1)})},[e]),u=f.useRef(null),d=S(o=>o.currImage);f.useEffect(()=>{if(u.current)return T.bind(u.current),()=>{T.unbind()}},[]);const x=G();return n.jsxs(n.Fragment,{children:[s&&n.jsx(H,{}),n.jsxs(i,{sx:{display:"flex",flexDirection:x?"row":"column",alignItems:"center",justifyContent:"center",maxWidth:x?"lg":"sm",gap:2,width:"100%",mx:"auto"},children:[n.jsxs(Y,{onLoad:a,defaultImage:N.decode,disabled:s,children:[n.jsx("canvas",{ref:u,style:{width:"100%",height:"100%",display:d?"block":"none"}}),!d&&n.jsx(K,{text:s?"加载中...":"只是一张画布",action:"加载示例图片",onClick:h,disabled:s})]}),n.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:2,width:"100%"},children:[n.jsxs(V,{children:[n.jsx(te,{}),n.jsx(i,{sx:{mt:2}}),n.jsx(ne,{})]}),n.jsx(V,{children:n.jsx(re,{})}),n.jsx(ae,{})]})]})]})}function te(){const s=c(a=>a.lowerThreshold),t=c(a=>a.higherThreshold),e=c(a=>a.setLowerThreshold),r=c(a=>a.setHigherThreshold);return n.jsxs(i,{sx:{display:"flex",flexDirection:"column",px:2,width:"100%",textAlign:"center"},children:[n.jsxs(i,{sx:{display:"flex",flexDirection:"row",alignItems:"end",justifyContent:"center",gap:1,with:"100%"},children:[n.jsx(P,{variant:"subtitle1",children:"1. 阈值调整"}),n.jsx(W,{message:"大多数情况下只需要调整右端阈值"})]}),n.jsx(O,{value:[s,t],onChange:(a,h)=>{e(h[0]),r(h[1])},min:0,max:255,step:I.thresholdStep,valueLabelDisplay:"auto"}),n.jsxs(i,{sx:{display:"flex",flexDirection:"row",gap:1},children:[n.jsx(i,{sx:{flex:2}}),n.jsx(F,{realValue:s,onSubmit:a=>{e(a)},min:0,max:Math.max(t-1,0),step:I.thresholdStep,sx:{width:"100px"},variant:"standard"}),n.jsx(i,{sx:{flex:1}}),n.jsx(F,{realValue:t,onSubmit:a=>{r(a)},min:Math.max(s+1,1),max:255,step:I.thresholdStep,sx:{width:"100px"},variant:"standard"}),n.jsx(i,{sx:{flex:2}})]})]})}function ne(){const s=c(e=>e.contrast),t=c(e=>e.setContrast);return n.jsxs(i,{sx:{display:"flex",flexDirection:"column",px:2,width:"100%",textAlign:"center"},children:[n.jsx(i,{sx:{display:"flex",flexDirection:"row",alignItems:"center",gap:1,with:"100%",justifyContent:"center"},children:n.jsx(P,{variant:"subtitle1",children:"2. 对比度调整"})}),n.jsx(O,{value:s,onChange:(e,r)=>{t(r)},min:B,max:A,step:E.contrastStep,valueLabelDisplay:"auto"}),n.jsxs(i,{sx:{display:"flex",flexDirection:"row",gap:1},children:[n.jsx(i,{sx:{flex:2}}),n.jsx(F,{realValue:s,onSubmit:e=>{t(e)},min:B,max:A,step:E.contrastStep,sx:{width:"100px"},variant:"standard"}),n.jsx(i,{sx:{flex:1}}),n.jsx(L,{size:"small",onClick:()=>{t(I.contrast)},sx:{width:"100px"},children:"重置对比度"}),n.jsx(i,{sx:{flex:2}})]})]})}function re(){const s=c(e=>e.method),t=c(e=>e.setMethod);return n.jsxs(i,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",gap:1},children:[n.jsx(P,{variant:"subtitle1",children:"3. 其他像素处理方式:"}),n.jsxs(Q,{value:s,size:"small",onChange:e=>{t(e.target.value)},children:[n.jsx(j,{value:"ltavg",children:"临近平均"}),n.jsx(j,{value:"lcopy",children:"左侧复制"}),n.jsx(j,{value:"tcopy",children:"上方复制"}),n.jsx(j,{value:"transparent",children:"置为透明"}),n.jsx(j,{value:"black",children:"置为黑色"}),n.jsx(j,{value:"white",children:"置为白色"})]}),n.jsx(W,{message:"此选项不会大幅影响显形质量"})]})}function ae(){const s=c(r=>r.saveFormat),t=c(r=>r.setSaveFormat),e=f.useCallback(r=>{T.saveCurrentImage(r).then(a=>{_(`已保存为: ${a}`)}).catch(a=>{console.error("Failed to save image:",a),C("保存显示图像失败")})},[]);return n.jsxs(i,{sx:{width:"100%",display:"flex",flexDirection:"row",gap:1},children:[n.jsx(L,{sx:{flex:1},variant:"contained",onClick:()=>{e(s)},children:"保存显示图像"}),n.jsx(X,{format:s,onChange:r=>{t(r)}})]})}export{ie as default};
