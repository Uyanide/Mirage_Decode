import{K as ee,C as L,r as f,M as x,g as O,j as t,B as g,H as M,T as v,N as te,I as V,L as _,b as C,G as se,c as ae,a as ne,f as W,S as ie,P as R,J as re,m as G,h as E}from"./index-CIQJMMa6.js";import{b as J,n as y,a as T,c as $,j as oe,k as b,T as P,l as le,i as ce,C as K,P as he,F as de,H as S,I as ue,S as z,d as F}from"./format-selector-B6b6QIw2.js";import{G as N,N as H,D as xe,c as ge,d as A,e as fe,u as B,F as me,a as pe}from"./format-warn-dialog-BAG3DaA0.js";const ve=a=>(s,e,n)=>(n.setState=(o,i,...c)=>{const l=typeof o=="function"?ee(o):o;return s(l,i,...c)},a(n.setState,e,n)),U=ve;function je({inputs:a,output:s}){if(a.length===0)return console.error("No input images provided for encoding."),!1;const e=a[0].imageData.width,n=a[0].imageData.height,o=a[0].imageData.data.length;for(const l of a)if(l.imageData.width!==e||l.imageData.height!==n)return console.error("All input images must have the same dimensions."),!1;if(s.width!==e||s.height!==n)return console.error("Output image must have the same dimensions as input images."),!1;const i=s.data,c=a.reduce((l,d)=>l+d.weight,0);for(let l=0,d=0,r=0;l<o;l+=4){const h=Ce(d,r,c,a),I=h.lowerThreshold,u=h.higherThreshold,w=h.imageData.data[l],D=h.imageData.data[l+1],q=h.imageData.data[l+2],Q=h.imageData.data[l+3],X=k(w,I,u),Y=k(D,I,u),Z=k(q,I,u);i[l]=X,i[l+1]=Y,i[l+2]=Z,i[l+3]=Q,d++,d>=e&&(d=0,r++)}return!0}function k(a,s,e){return Math.floor(Math.max(s,Math.min(a*(e-s)/255+s,e)))}function Ce(a,s,e,n){const o=(a+s)%e;for(let i=0,c=0;i<n.length&&c<e;i++){if(c+n[i].weight>o)return n[i];c+=n[i].weight}return n[n.length-1]}class we extends J{resizedData=y();adjustedData=y();index;constructor(s){super(),this.index=s}bind(s){super.bind(s),this.putImageData(this.adjustedData)}resizeCover(s,e){this.srcData.v&&T.resizeCover(s,e,this.srcData,this.resizedData)}adjust(){if(!this.resizedData.v)return;const s=m.getState().getConfig(this.index),e=y();s.isGray?T.toGray(this.resizedData,e):e.v=this.resizedData.v;const n=y();s.contrast!==0?T.adjustContrast(s.contrast,e,n):n.v=e.v,this.adjustedData.v=n.v}}class De extends J{resultData=y();inputCanvases=new Map;bind(s){super.bind(s),this.putImageData(this.resultData)}resize(s){for(const e of this.inputCanvases.values())e.resizeCover(s.width,s.height),e.adjust()}createInputCanvas(s){this.inputCanvases.has(s)||this.inputCanvases.set(s,new we(s))}removeInputCanvas(s){this.inputCanvases.has(s)&&(this.inputCanvases.delete(s),j.getState().setHasInput(s,!1))}bindInputCanvas(s,e){this.inputCanvases.get(s)?.bind(e)}unbindInputCanvas(s){this.inputCanvases.get(s)?.unbind()}adjustInput(s){const e=this.inputCanvases.get(s);if(!e){console.error(`Input canvas for index ${s.toString()} does not exist.`);return}e.adjust(),e.putImageData(e.adjustedData)}setInputImage(s,e){const n=this.inputCanvases.get(e);if(!n)return console.error(`Input canvas for index ${e.toString()} does not exist.`),!1;n.setImage(s,!1);const o=m.getState().size;n.resizeCover(o.width,o.height),n.adjust(),n.putImageData(n.adjustedData);const i=j.getState().getHasInput(e);return j.getState().setHasInput(e,!0),!i}encode(){const s=o=>{console.error(o),this.resultData.v=null,j.setState({hasOutput:!1})},e=[];for(const[o,i]of this.inputCanvases.entries()){const c=m.getState().getConfig(o);i.adjustedData.v&&e.push({imageData:i.adjustedData.v,lowerThreshold:c.lowerThreshold,higherThreshold:c.higherThreshold,weight:c.weight})}if(e.length===0){s("No valid input images to encode.");return}if(T.matchSize({v:e[0].imageData},this.resultData),!this.resultData.v){s("Failed to create output image data.");return}if(!je({inputs:e,output:this.resultData.v})){s("Failed to encode image.");return}this.putImageData(this.resultData),j.setState({hasOutput:!0})}encodeResultToFile(s){return this.encodeImageFile(this.resultData,s)}async saveResult(s){return this.saveImageFile(await this.encodeResultToFile(s),s)}}const p=new De,m=L()(U((a,s)=>({configs:{},indexes:[],size:{width:x.width,height:x.height},saveFormat:x.saveFormat,getMaxIndex:()=>{const e=s().indexes;return e.length>0?e[e.length-1]:-1},createConfig:()=>{const e=s().getMaxIndex()+1;p.createInputCanvas(e),a(n=>{n.indexes.push(e),n.configs[e]={lowerThreshold:x.lowerThreshold,higherThreshold:x.higherThreshold,contrast:x.contrast,isGray:x.isGray,weight:x.weight}})},getConfig:e=>s().configs[e]||{lowerThreshold:x.lowerThreshold,higherThreshold:x.higherThreshold,contrast:x.contrast,isGray:x.isGray,weight:x.weight},setConfigValue:(e,n,o)=>{a(i=>{if(i.configs[e])switch(n){case"lowerThreshold":case"higherThreshold":case"contrast":case"weight":i.configs[e][n]=Number(o);break;case"isGray":i.configs[e][n]=!!o;break}})},removeConfig:e=>{p.removeInputCanvas(e),a(n=>{delete n.configs[e],n.indexes=n.indexes.filter(o=>o!==e)})},setSize:(e,n)=>{a({size:{width:e,height:n}})},testConflict:()=>{const e=[],n=s().configs;for(const i of j.getState().hasInput){const c=n[i];if(c){const{lowerThreshold:l,higherThreshold:d}=c;if(l>d)return!0;e.push({l,r:d})}}e.sort((i,c)=>i.l-c.l);let o=-1;for(const i of e){if(i.l<=o)return!0;o=i.r}return!1},setSaveFormat:e=>{a({saveFormat:e})}}))),j=L()(U((a,s)=>({hasOutput:!1,hasInput:new Set,setHasOutput:e=>{a({hasOutput:e})},setHasInput:(e,n)=>{a(o=>{n?o.hasInput.add(e):o.hasInput.delete(e)})},getHasInput:e=>s().hasInput.has(e)})));function Ie(){const a=m(e=>e.indexes),s=m(e=>e.createConfig);f.useEffect(()=>{a.length===0&&s()},[a,s])}function Pe(){const a=O();return Ie(),t.jsxs(g,{sx:{display:"flex",flexDirection:"column",width:"100%",maxWidth:a?"lg":"sm",mx:"auto",gap:1},children:[t.jsx(ye,{}),t.jsx(Se,{}),t.jsxs(g,{sx:{display:"flex",flexDirection:"column",width:"100%",maxWidth:"sm",mx:"auto",gap:1},children:[t.jsx(Fe,{}),t.jsx(ke,{}),t.jsx(We,{})]})]})}function ye(){const a=M(s=>s.setCurrentRoute);return t.jsxs(g,{sx:{display:"flex",flexDirection:"column",p:1,gap:1},children:[t.jsxs(v,{variant:"h6",color:"primary",children:[t.jsx("b",{children:"å¤åˆ"}),"å…‰æ£±å¦å…‹"]}),t.jsxs(v,{variant:"body1",children:["è¿™æ˜¯å…è®¸è¾“å…¥",t.jsx("b",{children:"è¶…è¿‡ä¸¤å¼ å›¾ç‰‡"}),'çš„æ¨¡å¼ ğŸ¤“ æ¨èåœ¨å¯¹"å…‰æ£±å¦å…‹"çš„åŸç†æœ‰åŸºç¡€çš„äº†è§£åå†ä½¿ç”¨ã€‚æˆ–è€…å¦‚æœæ‚¨æ°å·§ç†è§£èƒ½åŠ›è¶…ç¾¤ ğŸ§ ä¹Ÿå¯ä»¥è¾¹è¯•è¾¹å­¦â€”â€”æ‰€æœ‰çš„å›¾ç‰‡å‡åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°ç”Ÿæˆï¼Œæ²¡æœ‰äººä¼šæœ‰ä»»ä½•æ„è§ ğŸ˜‰']}),t.jsx(v,{variant:"body1",children:"åœ¨æˆåŠŸåŠ è½½ä¸€å¼ å›¾ç‰‡åï¼Œä¼šæœ‰æ–°çš„å›¾ç‰‡è¾“å…¥æ¡†å‡ºç°ä»¥ä¾¿æ‚¨æ·»åŠ æ›´å¤šå›¾ç‰‡ã€‚åŒç†ï¼Œç§»é™¤ä¸€å¼ å›¾ç‰‡ä¹Ÿä¼šç›¸åº”åœ°ç§»é™¤å®ƒæ‰€å±çš„è¾“å…¥æ¡†ã€‚å¾ˆç›´æ¥çš„äº¤äº’æ–¹å¼ï¼Œä¸æ˜¯å— ğŸ˜Š"}),t.jsxs(v,{variant:"body1",children:["å¦å¤–ï¼Œç›¸è¾ƒ1.xç‰ˆæœ¬ï¼Œ",t.jsx(te,{component:"button",variant:"body1",onClick:()=>{a(V.decode)},children:"æ˜¾å½¢ç•Œé¢"})," ","çš„é˜ˆå€¼æ»‘æ¡å¤šäº†ä¸€ä¸ªç«¯ç‚¹ï¼Œè¿™å°±æ˜¯ä¸ºæ˜¾å½¢å¤åˆå¦å…‹å‡†å¤‡çš„ ğŸ˜"]}),t.jsxs(v,{variant:"body1",children:["ä»¥åŠè¯·æ³¨æ„ï¼Œç”±äºæ¸²æŸ“çš„å¤æ‚æ€§ï¼Œæ­¤é¡µé¢",t.jsx("b",{children:"ä¸æä¾›"}),"ç»“æœçš„å®æ—¶é¢„è§ˆ ğŸ˜¥ å¦‚æœæ›´æ–°äº†å‚æ•°è¯·è®°å¾—ç‚¹å‡»æŒ‰é’®é‡æ–°ç”Ÿæˆ ğŸ™‚"]})]})}function Se(){const a=O(),s=m(e=>e.indexes);return t.jsx(N,{container:!0,spacing:2,maxWidth:a?"lg":"sm",children:s.map(e=>t.jsx(N,{size:a?6:12,children:t.jsx(be,{index:e})},e))})}function be({index:a}){const s=R[a%R.length],e=j(n=>n.getHasInput(a));return t.jsx(ie,{primaryPaletteKey:s,children:t.jsx($,{children:t.jsxs(g,{sx:{display:"flex",flexDirection:"row",width:"100%",gap:2,alignItems:"center"},children:[t.jsx(Te,{index:a,hasImage:e}),t.jsx(ze,{index:a,disabled:!e})]})})})}function Te({index:a,hasImage:s}){const n=re()?120:200,o=m(r=>r.createConfig),i=m(r=>r.removeConfig),c=f.useCallback(r=>{p.setInputImage(r,a)&&o()},[a,o]),l=()=>{s&&i(a)},d=f.useRef(null);return f.useEffect(()=>(p.bindInputCanvas(a,d.current),()=>{p.unbindInputCanvas(a)}),[a]),t.jsxs(g,{sx:{display:"flex",flexDirection:"column",gap:1,px:1,width:n},children:[t.jsx(ue,{onconfirm:c,label:"åŠ è½½"}),!s&&t.jsx(K,{text:"(ï½¥_ï½¥`)>",aspectRatio:"1",styles:{width:"100%",objectFit:"contain"}}),t.jsx("canvas",{ref:d,style:{maxWidth:n,maxHeight:n,display:s?"block":"none",objectFit:"contain"}}),t.jsx(C,{variant:"outlined",size:"small",sx:{width:"100%",border:"2px solid"},onClick:l,disabled:!s,children:"ç§»é™¤"})]})}function ze({index:a,disabled:s}){const e=m(r=>r.getConfig(a)),n=m(r=>r.setConfigValue),o=r=>{n(a,"lowerThreshold",r)},i=r=>{n(a,"higherThreshold",r)},c=r=>{n(a,"contrast",r)},l=()=>{n(a,"isGray",!e.isGray)},d=r=>{n(a,"weight",r)};return f.useEffect(()=>{p.adjustInput(a)},[a,e.contrast,e.lowerThreshold,e.higherThreshold,e.isGray]),t.jsxs(g,{sx:{flex:1,display:"flex",flexDirection:"column"},children:[t.jsxs(g,{sx:{display:"flex",flexDirection:"row",alignItems:"center"},children:[t.jsx(v,{variant:"body2",children:"1. è‰²é˜¶ç«¯ç‚¹:"}),t.jsx(g,{sx:{flex:1}}),t.jsx(S,{message:"å»ºè®®é¿å…å’Œå…¶ä»–è¾“å…¥å›¾ç‰‡çš„è‰²é˜¶é‡å "})]}),t.jsx(z,{value:[e.lowerThreshold,e.higherThreshold],min:0,max:255,step:x.thresholdStep,onChange:(r,h)=>{o(h[0]),i(h[1])},disabled:s}),t.jsxs(g,{sx:{display:"flex",flexDirection:"row",gap:1},children:[t.jsx(F,{value:e.lowerThreshold,inputProps:{step:x.thresholdStep,min:0,max:255,type:"number"},sx:{width:"80px"},onChange:r=>{const h=Number(r.target.value);isNaN(h)||o(h)},disabled:s}),t.jsx(F,{value:e.higherThreshold,inputProps:{step:x.thresholdStep,min:0,max:255,type:"number"},sx:{width:"80px"},onChange:r=>{const h=Number(r.target.value);isNaN(h)||i(h)},disabled:s})]}),t.jsxs(g,{sx:{mt:1,display:"flex",flexDirection:"row",alignItems:"center"},children:[t.jsx(v,{variant:"body2",children:"2. å¯¹æ¯”åº¦:"}),t.jsx(g,{sx:{flex:1}}),t.jsx(S,{message:"ä¸åˆç†çš„å¯¹æ¯”åº¦ä¼šä¸¥é‡é™ä½æ˜¾å½¢è´¨é‡"})]}),t.jsx(z,{value:e.contrast,min:E,max:G,step:x.contrastStep,onChange:(r,h)=>{c(h)},disabled:s}),t.jsxs(g,{sx:{display:"flex",flexDirection:"row",gap:1},children:[t.jsx(F,{value:e.contrast,inputProps:{step:x.contrastStep,min:E,max:G,type:"number"},sx:{width:"80px"},onChange:r=>{const h=Number(r.target.value);isNaN(h)||c(h)},disabled:s}),t.jsx(C,{size:"small",sx:{width:"80px"},onClick:()=>{c(0)},disabled:s,children:"é‡ç½®å¯¹æ¯”åº¦"})]}),t.jsxs(g,{sx:{mt:1,display:"flex",flexDirection:"row",alignItems:"center",gap:1},children:[t.jsx(v,{variant:"body2",children:"3. å–ç°åº¦:"}),t.jsx(pe,{size:"medium",value:e.isGray,onClick:l,disabled:s}),t.jsx(g,{sx:{flex:1}}),t.jsx(S,{message:"èˆå¼ƒé¢œè‰²å¯æ˜¾è‘—æå‡æŠ—å‹ç¼©èƒ½åŠ›"})]}),t.jsxs(g,{sx:{mt:1,display:"flex",flexDirection:"row",alignItems:"center",gap:1},children:[t.jsx(v,{variant:"body2",children:"4. æ··åˆæƒé‡:"}),t.jsx(z,{value:e.weight,min:1,max:4,step:1,onChange:(r,h)=>{d(h)},sx:{flex:1,ml:1,minWidth:"60px"},valueLabelDisplay:"auto",marks:!0,disabled:s}),t.jsx(g,{sx:{flex:1}}),t.jsx(S,{message:"æƒé‡è¶Šé«˜ï¼Œè¶Šå®¹æ˜“ç›´æ¥çœ‹å‡º"})]})]})}function Fe(){const a=m(r=>r.size),s=m(r=>r.setSize),[e,n]=f.useState(!1),[o,i]=f.useState(a.width),[c,l]=f.useState(a.height),d=f.useCallback((r,h)=>{n(!0);try{s(r,h),p.resize({width:r,height:h})}finally{n(!1)}},[s]);return t.jsxs(t.Fragment,{children:[e&&t.jsx(_,{}),t.jsx($,{children:t.jsxs(oe,{sx:{display:"flex",flexDirection:"row",gap:1,width:"100%",alignItems:"center",justifyContent:"center"},children:[t.jsxs(g,{sx:{display:"flex",flexDirection:"column",gap:1},children:[t.jsxs(g,{sx:{display:"flex",flexDirection:"row",alignItems:"end",gap:1},children:[t.jsx(b,{children:"å½“å‰å®½åº¦:"}),t.jsx(P,{value:a.width,size:"small",variant:"standard",sx:{maxWidth:"60px"},disabled:!0}),t.jsx(b,{children:"æ–°å®½åº¦:"}),t.jsx(H,{initValue:o,onChange:i,size:"small",variant:"standard",sx:{maxWidth:"60px"},min:x.minSize,max:x.maxSize})]}),t.jsxs(g,{sx:{display:"flex",flexDirection:"row",alignItems:"end",gap:1},children:[" ",t.jsx(b,{children:"å½“å‰é«˜åº¦:"}),t.jsx(P,{value:a.height,size:"small",variant:"standard",sx:{maxWidth:"60px"},disabled:!0}),t.jsx(b,{children:"æ–°é«˜åº¦:"}),t.jsx(H,{initValue:c,onChange:l,size:"small",variant:"standard",sx:{maxWidth:"60px"},min:x.minSize,max:x.maxSize})]})]}),t.jsx(C,{sx:{aspectRatio:1,minWidth:0,padding:0,p:1},component:"label",onClick:()=>{d(o,c)},children:t.jsx(le,{})})]})})]})}function ke(){const[a,s]=f.useState(!1),e=j(d=>d.hasOutput),n=m(d=>d.testConflict),[o,i]=f.useState(!1),c=f.useCallback(d=>{s(!0);try{if(!d&&n()){i(!0);return}p.encode()}finally{s(!1)}},[n]),l=f.useRef(null);return f.useEffect(()=>(p.bind(l.current),()=>{p.unbind()}),[]),t.jsxs(g,{sx:{display:"flex",flexDirection:"column",gap:1},children:[a&&t.jsx(_,{}),t.jsxs(ce,{open:o,onClose:()=>{i(!1)},maxWidth:"sm",fullWidth:!0,sx:{zIndex:se.dialog},children:[t.jsx(xe,{children:"é˜ˆå€¼å­˜åœ¨å†²çªï¼"}),t.jsxs(ge,{children:[t.jsx(A,{children:"å»ºè®®é¿å…è¾“å…¥å›¾ç‰‡çš„è‰²é˜¶ç«¯ç‚¹ä¹‹é—´å‘ç”Ÿé‡å ï¼Œå¦åˆ™æ˜¾å½¢æ•ˆæœå¯èƒ½ä¸å¦‚é¢„æœŸã€‚"}),t.jsx(A,{children:"ä¾‹å¦‚ 1-24 ä¸ 12-36 å­˜åœ¨é‡å , å»ºè®®è°ƒæ•´ä¸º 0-24 ä¸ 25-49"})]}),t.jsxs(fe,{children:[t.jsx(C,{onClick:()=>{i(!1)},children:"å–æ¶ˆ"}),t.jsx(C,{onClick:()=>{i(!1),c(!0)},autoFocus:!0,children:"ä»ç„¶ç»§ç»­"})]})]}),t.jsx(C,{variant:"contained",onClick:()=>{c(!1)},fullWidth:!0,children:"å…‰æ£±ï¼Œå¯åŠ¨ï¼"}),!e&&t.jsx(K,{text:"åªæ˜¯ä¸€å¼ ç”»å¸ƒ",styles:{width:"100%",objectFit:"contain"}}),t.jsx("canvas",{ref:l,style:{maxWidth:"100%",maxHeight:"100%",display:e?"block":"none"}})]})}function We(){const a=m(u=>u.saveFormat),s=m(u=>u.setSaveFormat),e=B(u=>u.showWarning),n=B(u=>u.setShowWarning),[o,i]=f.useState(!1),c=ae(u=>u.setImages),l=M(u=>u.setCurrentRoute),[d,r]=f.useState(!1),h=f.useCallback((u,w)=>{if(!w&&u!=="JPEG"&&e){i(!0);return}r(!0),p.saveResult(u).then(D=>{ne(`å·²ä¿å­˜ä¸º ${D}`)}).catch(D=>{console.error("Failed to save result:",D),W("ä¿å­˜å¤±è´¥")}).finally(()=>{r(!1)})},[e]),I=f.useCallback(u=>{r(!0),(async()=>{const w=await p.encodeResultToFile(u),D=await he.fromFileData(w);c([D]),l(V.decode)})().catch(w=>{console.error("Failed to encode result:",w),W("è·³è½¬å¤±è´¥")}).finally(()=>{r(!1)})},[c,l]);return t.jsxs(g,{sx:{width:"100%",display:"flex",flexDirection:"row",gap:1},children:[t.jsx(me,{show:o,setShow:i,saveFormat:a,handleSave:h,showWarning:e,setShowWarning:n}),t.jsx(C,{sx:{flex:1},variant:"contained",onClick:()=>{h(a,!1)},disabled:d,children:"ä¿å­˜ç»“æœ"}),t.jsx(C,{sx:{flex:1},variant:"contained",color:"secondary",onClick:()=>{I(a)},disabled:d,children:"æ˜¾å½¢æµ‹è¯•"}),t.jsx(de,{format:a,onChange:u=>{s(u)},disabled:d}),t.jsx(S,{message:"é JPEG æ ¼å¼æœ‰è¾ƒé«˜åœ°è¢«ç¤¾äº¤å¹³å°å¼ºåˆ¶å‹ç¼©çš„é£é™©"})]})}export{Pe as default};
