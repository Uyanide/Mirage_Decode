import{r as h,s as P,a as H,j as e,B as l,L as N,b as k,u as n,c as S,I as w,d as O,e as _,f as M,g as y,h as $,T as j,D as m,E as A,m as z,i as E,k as U}from"./index-D0Locfbb.js";import{P as R,I as q,D as J,L as C,a as K,n as V,G as I,C as Q,b as B,H as F,S as W,N as p,c as X,M as f,F as Y}from"./number-input-BBSwyfBK.js";function Z({onLoad:i,children:t,defaultImage:s,disabled:r}){const[a,d]=h.useState(!1),c=h.useCallback(o=>{(async()=>{d(!0);const x=await o();if(x.length===0){P("没有图片被加载");return}const G=x.map(D=>new Promise(L=>{R.fromFileData(D).then(v=>{L(v)}).catch(v=>{console.error("Failed to load image:",v),L(null)})})),b=(await Promise.all(G)).filter(D=>D!==null);b.length!==0&&(H(`成功加载 ${b.length.toString()} 张图片`),i(b))})().catch(x=>{console.error("Failed to load image:",x),P("加载图片失败")}).finally(()=>{d(!1)})},[i]),g=()=>C.fromFileSelect(!0),u=o=>C.fromDropItems(o,!0);return e.jsxs(l,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:1,width:"100%"},children:[a&&e.jsx(N,{}),e.jsxs(l,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",gap:1,width:"100%"},children:[e.jsx(l,{sx:{flex:1},children:e.jsx(q,{onconfirm:o=>{i([o])},label:"加载单张",disabled:a||r,defaultImage:s})}),e.jsx(l,{sx:{flex:1},children:e.jsx(k,{variant:"contained",color:"secondary",onClick:()=>{c(g)},fullWidth:!0,disabled:a||r,children:"加载多张"})})]}),e.jsx(J,{onDrop:o=>{c(()=>u(o))},disabled:a||r,children:t})]})}class ee extends K{decodedData=V();adjustedData=V();bind(t){super.bind(t),this.subscribe(n.subscribe(s=>s.lowerThreshold,()=>{this.decode()})),this.subscribe(n.subscribe(s=>s.higherThreshold,()=>{this.decode()})),this.subscribe(n.subscribe(s=>s.method,()=>{this.decode()})),this.subscribe(n.subscribe(s=>s.contrast,()=>{this.adjust(!0)})),this.subscribe(S.subscribe(s=>s.currImage,s=>{s?this.setImage(s.image):this.clearImage()},{fireImmediately:!0})),this.subscribe(n.subscribe(s=>s.iterations,()=>{const{method:s}=n.getState();s==="ltavg"&&this.decode()}))}setImage(t){super.setImage(t,!1),this.setPreset(t.metadata),this.decode(),this.adjust(),this.putImageData(this.adjustedData)}clearImage(){this.srcData.v=null,this.decodedData.v=null,this.adjustedData.v=null,this.clear()}setPreset(t){console.log("Setting preset from string:",t);const{lowerThreshold:s,higherThreshold:r,contrast:a,iterations:d}=n.getState(),c={lowerThreshold:s,higherThreshold:r,method:"black",contrast:a,iterations:d};w.decodePreset(t,c),this.setValues(c)}setValues(t){n.setState({lowerThreshold:t.lowerThreshold,higherThreshold:t.higherThreshold,contrast:t.contrast})}decode=()=>{if(!this.srcData.v){console.warn("No original image data to decode");return}if(O.matchSize(this.srcData,this.decodedData),!this.decodedData.v){console.warn("No buffer available");return}const{lowerThreshold:t,higherThreshold:s,method:r,contrast:a,iterations:d}=n.getState();w.prismDecode(this.srcData.v,this.decodedData.v,{lowerThreshold:t,higherThreshold:s,method:r,contrast:a,iterations:d}),this.adjust()};adjust(t){const{contrast:s}=n.getState();t||s!==0?w.adjustContrast(s,this.decodedData,this.adjustedData):this.adjustedData.v=this.decodedData.v,this.putImageData(this.adjustedData)}async saveCurrentImage(t){return this.saveImageFile(await this.encodeImageFile(this.adjustedData,t),t)}async saveOriginalImage(t){return this.saveImageFile(await this.encodeImageFile(this.srcData,t),t)}}const T=new ee;function oe(){const[i,t]=h.useState(!1),s=S(o=>o.setImages),r=_(o=>o.setShow),a=h.useCallback(o=>{s(o),o.length>1&&r(!0)},[s,r]),d=h.useCallback(()=>{t(!0),(async()=>{const o=await C.fromAssets(M.decode);if(o.length===0){y("加载默认图片失败");return}const x=await R.fromFileData(o[0]);s([x])})().catch(o=>{y("加载默认图片失败"),console.error("Failed to load default image:",o)}).finally(()=>{t(!1)})},[s]),c=h.useRef(null),g=S(o=>o.currImage);h.useEffect(()=>{if(c.current)return T.bind(c.current),()=>{T.unbind()}},[]);const u=$();return e.jsxs(e.Fragment,{children:[i&&e.jsx(N,{}),e.jsxs(I,{container:!0,spacing:2,sx:{maxWidth:u?"lg":"sm",mx:"auto"},children:[e.jsx(I,{size:u?6:12,children:e.jsxs(Z,{onLoad:a,defaultImage:M.decode,disabled:i,children:[e.jsx("canvas",{ref:c,style:{width:"100%",display:g?"block":"none"}}),!g&&e.jsx(Q,{text:i?"加载中...":"只是一张画布",action:"加载示例图片",onClick:d,disabled:i,styles:{width:"100%",aspectRatio:"1.54"}})]})}),e.jsx(I,{size:u?6:12,children:e.jsxs(l,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:2,width:"100%"},children:[e.jsxs(B,{children:[e.jsx(se,{}),e.jsx(l,{sx:{mt:2}}),e.jsx(te,{})]}),e.jsx(B,{children:e.jsx(ae,{})}),e.jsx(re,{})]})})]})]})}function se(){const i=n(a=>a.lowerThreshold),t=n(a=>a.higherThreshold),s=n(a=>a.setLowerThreshold),r=n(a=>a.setHigherThreshold);return e.jsxs(l,{sx:{display:"flex",flexDirection:"column",px:2,width:"100%",textAlign:"center"},children:[e.jsxs(l,{sx:{display:"flex",flexDirection:"row",alignItems:"end",justifyContent:"center",gap:1,with:"100%"},children:[e.jsx(j,{variant:"subtitle1",children:"1. 阈值调整"}),e.jsx(F,{message:"大多数情况下只需要调整右端阈值"})]}),e.jsx(W,{value:[i,t],onChange:(a,d)=>{s(d[0]),r(d[1])},min:0,max:255,step:m.thresholdStep,valueLabelDisplay:"auto"}),e.jsxs(l,{sx:{display:"flex",flexDirection:"row",gap:1},children:[e.jsx(l,{sx:{flex:2}}),e.jsx(p,{realValue:i,onSubmit:a=>{s(a)},min:0,max:Math.max(t-1,0),step:m.thresholdStep,sx:{width:"100px"},variant:"standard"}),e.jsx(l,{sx:{flex:1}}),e.jsx(p,{realValue:t,onSubmit:a=>{r(a)},min:Math.max(i+1,1),max:255,step:m.thresholdStep,sx:{width:"100px"},variant:"standard"}),e.jsx(l,{sx:{flex:2}})]})]})}function te(){const i=n(s=>s.contrast),t=n(s=>s.setContrast);return e.jsxs(l,{sx:{display:"flex",flexDirection:"column",px:2,width:"100%",textAlign:"center"},children:[e.jsx(l,{sx:{display:"flex",flexDirection:"row",alignItems:"center",gap:1,with:"100%",justifyContent:"center"},children:e.jsx(j,{variant:"subtitle1",children:"2. 对比度调整"})}),e.jsx(W,{value:i,onChange:(s,r)=>{t(r)},min:E,max:z,step:A.contrastStep,valueLabelDisplay:"auto"}),e.jsxs(l,{sx:{display:"flex",flexDirection:"row",gap:1},children:[e.jsx(l,{sx:{flex:2}}),e.jsx(p,{realValue:i,onSubmit:s=>{t(s)},min:E,max:z,step:A.contrastStep,sx:{width:"100px"},variant:"standard"}),e.jsx(l,{sx:{flex:1}}),e.jsx(k,{size:"small",onClick:()=>{t(m.contrast)},sx:{width:"100px"},children:"重置对比度"}),e.jsx(l,{sx:{flex:2}})]})]})}function ae(){const i=n(a=>a.method),t=n(a=>a.setMethod),s=n(a=>a.iterations),r=n(a=>a.setIterations);return e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(l,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",gap:1},children:[e.jsx(j,{variant:"subtitle1",children:"3. 其他像素处理方式:"}),e.jsxs(X,{value:i,size:"small",onChange:a=>{t(a.target.value)},children:[e.jsx(f,{value:"ltavg",children:"临近平均"}),e.jsx(f,{value:"transparent",children:"置为透明"}),e.jsx(f,{value:"black",children:"置为黑色"}),e.jsx(f,{value:"white",children:"置为白色"})]}),e.jsx(F,{message:"此选项不会大幅影响显形质量"})]}),U&&i==="ltavg"&&e.jsxs(l,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",gap:1},children:[e.jsx(j,{variant:"subtitle1",children:"4. 扩散迭代次数:"}),e.jsx(p,{realValue:s,size:"small",onSubmit:r,min:0,max:m.maxIterations,step:1,sx:{width:"100px"},variant:"standard"}),e.jsx(F,{message:"当出现未填充的像素时可适当增大; 当处理速度过慢时可适当减小"})]})]})}function re(){const i=n(r=>r.saveFormat),t=n(r=>r.setSaveFormat),s=h.useCallback(r=>{T.saveCurrentImage(r).then(a=>{H(`已保存为: ${a}`)}).catch(a=>{console.error("Failed to save image:",a),y("保存显示图像失败")})},[]);return e.jsxs(l,{sx:{width:"100%",display:"flex",flexDirection:"row",gap:1},children:[e.jsx(k,{sx:{flex:1},variant:"contained",onClick:()=>{s(i)},children:"保存显示图像"}),e.jsx(Y,{format:i,onChange:r=>{t(r)}})]})}export{oe as default};
