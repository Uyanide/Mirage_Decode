import{r as h,s as L,a as z,j as e,B as n,L as H,b as T,u as l,c as I,I as v,d as O,e as _,f as P,g as S,h as $,T as j,D as u,E as M,m as A,i as E}from"./index-B4ToWSyq.js";import{P as N,I as U,D as q,L as y,a as G,n as V,C as J,b as B,H as C,S as R,N as p,c as K,M as f,F as Q}from"./number-input-XGYSv-Kr.js";function X({onLoad:i,children:t,defaultImage:s,disabled:r}){const[a,d]=h.useState(!1),c=h.useCallback(o=>{(async()=>{d(!0);const x=await o();if(x.length===0){L("没有图片被加载");return}const W=x.map(D=>new Promise(k=>{N.fromFileData(D).then(w=>{k(w)}).catch(w=>{console.error("Failed to load image:",w),k(null)})})),b=(await Promise.all(W)).filter(D=>D!==null);b.length!==0&&(z(`成功加载 ${b.length.toString()} 张图片`),i(b))})().catch(x=>{console.error("Failed to load image:",x),L("加载图片失败")}).finally(()=>{d(!1)})},[i]),m=()=>y.fromFileSelect(!0),g=o=>y.fromDropItems(o,!0);return e.jsxs(n,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:1,width:"100%"},children:[a&&e.jsx(H,{}),e.jsxs(n,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",gap:1,width:"100%"},children:[e.jsx(n,{sx:{flex:1},children:e.jsx(U,{onconfirm:o=>{i([o])},label:"加载单张",disabled:a||r,defaultImage:s})}),e.jsx(n,{sx:{flex:1},children:e.jsx(T,{variant:"contained",color:"secondary",onClick:()=>{c(m)},fullWidth:!0,disabled:a||r,children:"加载多张"})})]}),e.jsx(q,{onDrop:o=>{c(()=>g(o))},disabled:a||r,children:t})]})}class Y extends G{decodedData=V();adjustedData=V();bind(t){super.bind(t),this.subscribe(l.subscribe(s=>s.lowerThreshold,()=>{this.decode()})),this.subscribe(l.subscribe(s=>s.higherThreshold,()=>{this.decode()})),this.subscribe(l.subscribe(s=>s.method,()=>{this.decode()})),this.subscribe(l.subscribe(s=>s.contrast,()=>{this.adjust(!0)})),this.subscribe(I.subscribe(s=>s.currImage,s=>{s?this.setImage(s.image):this.clearImage()},{fireImmediately:!0})),this.subscribe(l.subscribe(s=>s.iterations,()=>{const{method:s}=l.getState();s==="ltavg"&&this.decode()}))}setImage(t){super.setImage(t,!1),this.setPreset(t.metadata),this.decode(),this.adjust(),this.putImageData(this.adjustedData)}clearImage(){this.srcData.v=null,this.decodedData.v=null,this.adjustedData.v=null,this.clear()}setPreset(t){console.log("Setting preset from string:",t);const{lowerThreshold:s,higherThreshold:r,contrast:a,iterations:d}=l.getState(),c={lowerThreshold:s,higherThreshold:r,method:"black",contrast:a,iterations:d};v.decodePreset(t,c),this.setValues(c)}setValues(t){l.setState({lowerThreshold:t.lowerThreshold,higherThreshold:t.higherThreshold,contrast:t.contrast})}decode=()=>{if(!this.srcData.v){console.warn("No original image data to decode");return}if(O.matchSize(this.srcData,this.decodedData),!this.decodedData.v){console.warn("No buffer available");return}const{lowerThreshold:t,higherThreshold:s,method:r,contrast:a,iterations:d}=l.getState();v.prismDecode(this.srcData.v,this.decodedData.v,{lowerThreshold:t,higherThreshold:s,method:r,contrast:a,iterations:d}),this.adjust()};adjust(t){const{contrast:s}=l.getState();t||s!==0?v.adjustContrast(s,this.decodedData,this.adjustedData):this.adjustedData.v=this.decodedData.v,this.putImageData(this.adjustedData)}async saveCurrentImage(t){return this.saveImageFile(await this.encodeImageFile(this.adjustedData,t),t)}async saveOriginalImage(t){return this.saveImageFile(await this.encodeImageFile(this.srcData,t),t)}}const F=new Y;function ie(){const[i,t]=h.useState(!1),s=I(o=>o.setImages),r=_(o=>o.setShow),a=h.useCallback(o=>{s(o),o.length>1&&r(!0)},[s,r]),d=h.useCallback(()=>{t(!0),(async()=>{const o=await y.fromAssets(P.decode);if(o.length===0){S("加载默认图片失败");return}const x=await N.fromFileData(o[0]);s([x])})().catch(o=>{S("加载默认图片失败"),console.error("Failed to load default image:",o)}).finally(()=>{t(!1)})},[s]),c=h.useRef(null),m=I(o=>o.currImage);h.useEffect(()=>{if(c.current)return F.bind(c.current),()=>{F.unbind()}},[]);const g=$();return e.jsxs(e.Fragment,{children:[i&&e.jsx(H,{}),e.jsxs(n,{sx:{display:"flex",flexDirection:g?"row":"column",alignItems:"center",justifyContent:"center",maxWidth:g?"lg":"sm",gap:2,width:"100%",mx:"auto"},children:[e.jsxs(X,{onLoad:a,defaultImage:P.decode,disabled:i,children:[e.jsx("canvas",{ref:c,style:{width:"100%",display:m?"block":"none"}}),!m&&e.jsx(J,{text:i?"加载中...":"只是一张画布",action:"加载示例图片",onClick:d,disabled:i,styles:{width:"100%"}})]}),e.jsxs(n,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:2,width:"100%"},children:[e.jsxs(B,{children:[e.jsx(Z,{}),e.jsx(n,{sx:{mt:2}}),e.jsx(ee,{})]}),e.jsx(B,{children:e.jsx(se,{})}),e.jsx(te,{})]})]})]})}function Z(){const i=l(a=>a.lowerThreshold),t=l(a=>a.higherThreshold),s=l(a=>a.setLowerThreshold),r=l(a=>a.setHigherThreshold);return e.jsxs(n,{sx:{display:"flex",flexDirection:"column",px:2,width:"100%",textAlign:"center"},children:[e.jsxs(n,{sx:{display:"flex",flexDirection:"row",alignItems:"end",justifyContent:"center",gap:1,with:"100%"},children:[e.jsx(j,{variant:"subtitle1",children:"1. 阈值调整"}),e.jsx(C,{message:"大多数情况下只需要调整右端阈值"})]}),e.jsx(R,{value:[i,t],onChange:(a,d)=>{s(d[0]),r(d[1])},min:0,max:255,step:u.thresholdStep,valueLabelDisplay:"auto"}),e.jsxs(n,{sx:{display:"flex",flexDirection:"row",gap:1},children:[e.jsx(n,{sx:{flex:2}}),e.jsx(p,{realValue:i,onSubmit:a=>{s(a)},min:0,max:Math.max(t-1,0),step:u.thresholdStep,sx:{width:"100px"},variant:"standard"}),e.jsx(n,{sx:{flex:1}}),e.jsx(p,{realValue:t,onSubmit:a=>{r(a)},min:Math.max(i+1,1),max:255,step:u.thresholdStep,sx:{width:"100px"},variant:"standard"}),e.jsx(n,{sx:{flex:2}})]})]})}function ee(){const i=l(s=>s.contrast),t=l(s=>s.setContrast);return e.jsxs(n,{sx:{display:"flex",flexDirection:"column",px:2,width:"100%",textAlign:"center"},children:[e.jsx(n,{sx:{display:"flex",flexDirection:"row",alignItems:"center",gap:1,with:"100%",justifyContent:"center"},children:e.jsx(j,{variant:"subtitle1",children:"2. 对比度调整"})}),e.jsx(R,{value:i,onChange:(s,r)=>{t(r)},min:E,max:A,step:M.contrastStep,valueLabelDisplay:"auto"}),e.jsxs(n,{sx:{display:"flex",flexDirection:"row",gap:1},children:[e.jsx(n,{sx:{flex:2}}),e.jsx(p,{realValue:i,onSubmit:s=>{t(s)},min:E,max:A,step:M.contrastStep,sx:{width:"100px"},variant:"standard"}),e.jsx(n,{sx:{flex:1}}),e.jsx(T,{size:"small",onClick:()=>{t(u.contrast)},sx:{width:"100px"},children:"重置对比度"}),e.jsx(n,{sx:{flex:2}})]})]})}function se(){const i=l(a=>a.method),t=l(a=>a.setMethod),s=l(a=>a.iterations),r=l(a=>a.setIterations);return e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(n,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",gap:1},children:[e.jsx(j,{variant:"subtitle1",children:"3. 其他像素处理方式:"}),e.jsxs(K,{value:i,size:"small",onChange:a=>{t(a.target.value)},children:[e.jsx(f,{value:"ltavg",children:"临近平均"}),e.jsx(f,{value:"transparent",children:"置为透明"}),e.jsx(f,{value:"black",children:"置为黑色"}),e.jsx(f,{value:"white",children:"置为白色"})]}),e.jsx(C,{message:"此选项不会大幅影响显形质量"})]}),i==="ltavg"&&e.jsxs(n,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",gap:1},children:[e.jsx(j,{variant:"subtitle1",children:"4. 扩散迭代次数:"}),e.jsx(p,{realValue:s,size:"small",onSubmit:r,min:0,max:u.maxIterations,step:1,sx:{width:"100px"},variant:"standard"}),e.jsx(C,{message:"当出现未填充的像素时可适当增大; 当处理速度过慢时可适当减小"})]})]})}function te(){const i=l(r=>r.saveFormat),t=l(r=>r.setSaveFormat),s=h.useCallback(r=>{F.saveCurrentImage(r).then(a=>{z(`已保存为: ${a}`)}).catch(a=>{console.error("Failed to save image:",a),S("保存显示图像失败")})},[]);return e.jsxs(n,{sx:{width:"100%",display:"flex",flexDirection:"row",gap:1},children:[e.jsx(T,{sx:{flex:1},variant:"contained",onClick:()=>{s(i)},children:"保存显示图像"}),e.jsx(Q,{format:i,onChange:r=>{t(r)}})]})}export{ie as default};
