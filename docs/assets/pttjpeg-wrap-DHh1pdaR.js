const Y=console.log;function ar(){var F=this,p=1024,A=new Uint8Array(p),d=0,_=0,g=0,I=0;function E(){Q&&Q.write(A,0,d),I+=d,d=0}function $(){do{d>=p&&E();var l=g>>24&255;if(l==255){g&=16777215,A[d++]=255;continue}A[d++]=l,g<<=8,_-=8}while(_>=8)}function R(l){_>16&&$()}function K(l,B){g|=(l&(1<<B)-1)<<32-_-B,_+=B}var P=function(){C(),_>=8&&($(),E())},C=function(){F.putbits(255,32-_&7)},Q;this.getWrittenBytes=function(){return I},this.end=function(){E()},this.putbits=function(l,B){R(),K(l,B)},this.align=function(){C()},this.setByteWriter=function(l){Q=l},this.putshort=function(l){P(),A[d++]=(l&65535)>>>8,A[d++]=l&255},this.putbyte=function(l){P(),A[d++]=l}}var O0=new Uint32Array([0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0]),j0=new Uint32Array([0,1,2,3,4,5,6,7,8,9,10,11]),k0=new Uint32Array([0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125]),J0=new Uint32Array([1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250]),M0=new Uint32Array([0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0]),R0=new Uint32Array([0,1,2,3,4,5,6,7,8,9,10,11]),K0=new Uint32Array([0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119]),L0=new Uint32Array([0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250]),nr=new Uint32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63]),U=new Uint32Array([0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63]),m=new Float64Array([1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379]),ir=new Uint32Array([16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99]),ur=new Uint32Array([17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99]);function vr(){var F=new Float64Array(64),p=new Float64Array(64),A=new Float64Array(64),d=new Float64Array(64),_=new Float64Array(64),g=new Float64Array(64),I=new Float64Array(64),E=new Float64Array(64),$=new Float64Array(64),R=new Float64Array(64),K=new Float64Array(64),P=new Float64Array(64),C=new Float64Array(64),Q=new Float64Array(64),l=new Float64Array(64),B=new Float64Array(64),r0=new Int32Array(64),x0=new Int32Array(64),i0=new Int32Array(64),u0=1,v0,a;function f0(){this.val=0,this.len=0}var W=new Array(256),G=new Array(256),S=new Array(256),O=new Array(256),N0=function(r){r<=0&&(r=1),r>100&&(r=100),u0=r<50?5e3/r|0:200-(r<<1)|0,X0(u0)},X0=function(r){var e,x=64,i=8;for(e=0;e<x;++e){var t=(ir[e]*r+50)*.01|0;t<1?t=1:t>255&&(t=255),r0[U[e]]=t}for(e=0;e<x;e++){var u=(ur[e]*r+50)*.01|0;u<1?u=1:u>255&&(u=255),x0[U[e]]=u}e=0;var v,n;for(v=0;v<i;++v)for(n=0;n<i;++n)F[e]=1/(r0[U[e]]*m[v]*m[n]*i),p[e]=1/(x0[U[e]]*m[v]*m[n]*i),e++},L=function(r,e,x){var i=0,t=0,u,v,n;for(u=0;u<256;u++)n=new f0,n.val=0,n.len=0,x[u]=n;for(u=1;u<=16;++u){for(v=1;v<=r[u];++v){var n=new f0;n.val=i,n.len=u,x[e[t]]=n,t++,i++}i<<=1}},Z0=function(){L(O0,j0,W),L(M0,R0,G),L(k0,J0,S),L(K0,L0,O)};function H0(r,e){var x=0,i,t,u,v,n,f,b,s,c,o=8,h=64;for(c=0;c<o;++c){i=r[x],t=r[x+1],u=r[x+2],v=r[x+3],n=r[x+4],f=r[x+5],b=r[x+6],s=r[x+7];var y=i+s,w=i-s,N=t+b,k=t-b,h0=u+f,y0=u-f,l0=v+n,tr=v-n,J=y+l0,e0=y-l0,X=N+h0,Z=N-h0;r[x]=J+X,r[x+4]=J-X;var w0=(Z+e0)*.707106781;r[x+2]=e0+w0,r[x+6]=e0-w0,J=tr+y0,X=y0+k,Z=k+w;var d0=(J-Z)*.382683433,_0=.5411961*J+d0,A0=1.306562965*Z+d0,g0=X*.707106781,p0=w+g0,F0=w-g0;r[x+5]=F0+_0,r[x+3]=F0-_0,r[x+1]=p0+A0,r[x+7]=p0-A0,x+=8}for(x=0,c=0;c<o;++c){i=r[x],t=r[x+8],u=r[x+16],v=r[x+24],n=r[x+32],f=r[x+40],b=r[x+48],s=r[x+56];var I0=i+s,a0=i-s,T0=t+b,B0=t-b,V0=u+f,P0=u-f,Y0=v+n,er=v-n,M=I0+Y0,n0=I0-Y0,H=T0+V0,q=T0-V0;r[x]=M+H,r[x+32]=M-H;var E0=(q+n0)*.707106781;r[x+16]=n0+E0,r[x+48]=n0-E0,M=er+P0,H=P0+B0,q=B0+a0;var Q0=(M-q)*.382683433,W0=.5411961*M+Q0,S0=1.306562965*q+Q0,$0=H*.707106781,C0=a0+$0,G0=a0-$0;r[x+40]=G0+W0,r[x+24]=G0-W0,r[x+8]=C0+S0,r[x+56]=C0-S0,x++}var z;for(c=0;c<h;++c)z=r[c]*e[c],i0[c]=z>0?z+.5|0:z-.5|0;return i0}function q0(){a.putshort(65504),a.putshort(16),a.putbyte(74),a.putbyte(70),a.putbyte(73),a.putbyte(70),a.putbyte(0),a.putbyte(1),a.putbyte(1),a.putbyte(0),a.putshort(1),a.putshort(1),a.putbyte(0),a.putbyte(0)}function z0(r,e,x){a.putshort(65472),a.putshort(17),a.putbyte(8),a.putshort(e),a.putshort(r),a.putbyte(3),a.putbyte(1),a.putbyte(x?17:34),a.putbyte(0),a.putbyte(2),a.putbyte(17),a.putbyte(1),a.putbyte(3),a.putbyte(17),a.putbyte(1)}function U0(){a.putshort(65499),a.putshort(132),a.putbyte(0);var r,e=64;for(r=0;r<e;++r)a.putbyte(r0[r]);for(a.putbyte(1),r=0;r<e;++r)a.putbyte(x0[r])}function m0(){a.putshort(65476),a.putshort(418),a.putbyte(0);var r,e=11,x=16,i=161;for(r=0;r<x;++r)a.putbyte(O0[r+1]);for(r=0;r<=e;++r)a.putbyte(j0[r]);for(a.putbyte(16),r=0;r<x;++r)a.putbyte(k0[r+1]);for(r=0;r<=i;++r)a.putbyte(J0[r]);for(a.putbyte(1),r=0;r<x;++r)a.putbyte(M0[r+1]);for(r=0;r<=e;++r)a.putbyte(R0[r]);for(a.putbyte(17),r=0;r<x;++r)a.putbyte(K0[r+1]);for(r=0;r<=i;++r)a.putbyte(L0[r])}function D0(){a.putshort(65498),a.putshort(12),a.putbyte(3),a.putbyte(1),a.putbyte(0),a.putbyte(2),a.putbyte(17),a.putbyte(3),a.putbyte(17),a.putbyte(0),a.putbyte(63),a.putbyte(0)}function rr(){a.align(),a.putshort(65497),a.end()}function c0(r,e){return r<0?r+(1<<e)-1:r}function o0(r,e){for(e=0;r!=0;)r>>=1,e++;return e}function s0(r){return r>0?r:-r}function T(r,e,x,i,t){var u=H0(r,e),v,n;v=u[0]-x|0,n=u[0];var f=0,b=s0(v);f=o0(b,f),a.putbits(i[f].val,i[f].len),f&&(v=c0(v,f),a.putbits(v,f));for(var s,c,o=0,h=64,y=0;;){for(y++,s=0;(c=u[nr[y]])==0&&y<h;y++,s++);if(y>=h)break;for(;s>=16;)a.putbits(t[240].val,t[240].len),s-=16;var w=0,N=s0(c);w=o0(N,w);var k=s<<4|w;a.putbits(t[k].val,t[k].len),w&&(c=c0(c,w),a.putbits(c,w)),o=y}return o!=63&&a.putbits(t[0].val,t[0].len),n}function j(r,e,x,i,t){var u=v0.getPixels(r,e,8,8),v=u.buf,n,f,b,s=0,c,o,h;if(u.w==8&&u.h==8)for(f=0;f<8;f++)for(n=0;n<8;n++)b=u.offset+f*u.stride+n*4,c=v[b],o=v[b+1],h=v[b+2],x[s]=.299*c+.587*o+.114*h-128,i[s]=-.16874*c+-.33126*o+.5*h,t[s++]=.5*c+-.41869*o+-.08131*h;else for(f=0;f<8;f++)for(n=0;n<8;n++){var y=n,w=f;n>=u.w&&(y=u.w-1),f>=u.h&&(w=u.h-1),b=u.offset+w*u.stride+y*4,c=v[b],o=v[b+1],h=v[b+2],x[s]=.299*c+.587*o+.114*h-128,i[s]=-.16874*c+-.33126*o+.5*h,t[s++]=.5*c+-.41869*o+-.08131*h}}function V(r,e,x,i,t){r[e+0]=x[t+0]+x[t+1]+x[t+8]+x[t+9]+2>>2,r[e+1]=x[t+2]+x[t+3]+x[t+10]+x[t+11]+2>>2,r[e+2]=x[t+4]+x[t+5]+x[t+12]+x[t+13]+2>>2,r[e+3]=x[t+6]+x[t+7]+x[t+14]+x[t+15]+2>>2,r[e+4]=i[t+0]+i[t+1]+i[t+8]+i[t+9]+2>>2,r[e+5]=i[t+2]+i[t+3]+i[t+10]+i[t+11]+2>>2,r[e+6]=i[t+4]+i[t+5]+i[t+12]+i[t+13]+2>>2,r[e+7]=i[t+6]+i[t+7]+i[t+14]+i[t+15]+2>>2}function b0(r,e,x,i,t){V(r,0,e,x,0),V(r,8,e,x,16),V(r,16,e,x,32),V(r,24,e,x,48),V(r,32,i,t,0),V(r,40,i,t,16),V(r,48,i,t,32),V(r,56,i,t,48)}function xr(r,e){j(r,e,A,E,C),j(r+8,e,d,$,Q),j(r,e+8,_,R,l),j(r+8,e+8,g,K,B),b0(I,E,$,R,K),b0(P,C,Q,l,B)}this.version=function(){return"petit√≥JPEG 0.4"},this.setVerbosity=function(r){flagQuiet=!r},this.ByteWriter=function(){var r=10485760,e=new Uint8Array(r),x=0,i=function(t){for(var u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",v="",n,f,b,s,c,o,h,y=0;y<t.length;){if(n=t[y++],f=y<t.length?t[y++]:0,b=y<t.length?t[y++]:0,s=n>>>2,c=(n&3)<<4|f>>>4,o=(f&15)<<2|b>>>6,h=b&63,y>=t.length){var w=t.length%3;w==2&&(h=64),w==1&&(o=h=64)}v=v+u.charAt(s)+u.charAt(c)+u.charAt(o)+u.charAt(h)}return v};this.write=function(t,u,v){for(var n=0;n<v&&x+n<r;n++)e[x+n]=t[u+n];x+=n},this.getBase64Data=function(){return i(e.subarray(0,x))},this.getImgUrl=function(){return"data:image/jpeg;base64,"+this.getBase64Data()},this.getWrittenBytes=function(){return x}},this.dlog=Y,this.pttImage=function(r){var e=r.width,x=r.height,i=r.data;this.width=e,this.height=x,this.mcuPixels=function(){this.buf=null,this.offset=0,this.stride=0,this.xpos=0,this.ypos=0,this.w=0,this.h=0},this.getPixels=function(t,u,v,n){var f=new this.mcuPixels;return f.buf=i,f.stride=e*4,f.offset=u*f.stride+t*4,f.xpos=t,f.ypos=u,f.w=t+v>e?e-t:v,f.h=u+n>x?x-u:n,f}};var t0=0;this.getEncodeTime=function(){return t0},this.encode=function(r,e,x){this.encode_ext(r,e,x,"auto")},this.encode_ext=function(r,e,x,i){e||Y("input image not provided. aborting encode"),x||Y("byte writer not provided. aborting encode");var t=!0;i=="auto"&&(r>50?t=!0:t=!1),Y(`pttjpeg_encode  qual${r}:,  ${e.width}x${e.height}, ${i}:${t?"4:4:4":"4:2:0"}`);var u=new Date().getTime();N0(r),a=new ar,a.setByteWriter(x),v0=e,a.putshort(65496),q0(),U0(),z0(e.width,e.height,t),m0(),D0(),Y("wrote headers");var v=0,n=0,f=0,b=e.width,s=e.height,c,o;if(t)for(c=0;c<s;c+=8)for(o=0;o<b;o+=8)j(o,c,A,I,P),n=T(A,F,n,W,S),v=T(I,p,v,G,O),f=T(P,p,f,G,O);else for(c=0;c<s;c+=16)for(o=0;o<b;o+=16)xr(o,c),n=T(A,F,n,W,S),n=T(d,F,n,W,S),n=T(_,F,n,W,S),n=T(g,F,n,W,S),v=T(I,p,v,G,O),f=T(P,p,f,G,O);rr(),Y(`wrote EOI. ${a.getWrittenBytes()} bytes written`);var h=new Date().getTime();t0=h-u,Y(`${t0} ms`)},function(){Z0()}()}let D=null;function fr(F){D||(D=new vr);const p=[],A={write:(_,g,I)=>{p.push(_.slice(g,g+I))}};var d=new D.pttImage(F);return D.encode(99,d,A,"4:4:4"),new Uint8Array(p.reduce((_,g)=>_.concat(Array.from(g)),[]))}export{fr as encode};
