import{K as ee,C as B,r as x,M as u,g as L,j as s,B as f,H as O,T as C,N as te,I as M,L as V,b as I,c as se,a as ae,f as W,S as ne,P as R,J as ie,m as E,h as P}from"./index-lM4dmQ_l.js";import{b as J,n as S,a as T,c as _,j as oe,k as b,T as G,l as re,C as $,P as le,F as ce,H as y,I as he,S as z,d as F}from"./format-selector-Dj4_Uw1O.js";import{G as N,N as H,W as K,u as A,a as de}from"./warn-dialog-1ifTNM6-.js";const ue=a=>(t,e,n)=>(n.setState=(l,o,...h)=>{const c=typeof l=="function"?ee(l):l;return t(c,o,...h)},a(n.setState,e,n)),U=ue;function ge({inputs:a,output:t}){if(a.length===0)return console.error("No input images provided for encoding."),!1;const e=a[0].imageData.width,n=a[0].imageData.height,l=a[0].imageData.data.length;for(const c of a)if(c.imageData.width!==e||c.imageData.height!==n)return console.error("All input images must have the same dimensions."),!1;if(t.width!==e||t.height!==n)return console.error("Output image must have the same dimensions as input images."),!1;const o=t.data,h=a.reduce((c,d)=>c+d.weight,0);for(let c=0,d=0,i=0;c<l;c+=4){const r=fe(d,i,h,a),D=r.lowerThreshold,g=r.higherThreshold,j=r.imageData.data[c],w=r.imageData.data[c+1],q=r.imageData.data[c+2],Q=r.imageData.data[c+3],X=k(j,D,g),Y=k(w,D,g),Z=k(q,D,g);o[c]=X,o[c+1]=Y,o[c+2]=Z,o[c+3]=Q,d++,d>=e&&(d=0,i++)}return!0}function k(a,t,e){return Math.floor(Math.max(t,Math.min(a*(e-t)/255+t,e)))}function fe(a,t,e,n){const l=(a+t)%e;for(let o=0,h=0;o<n.length&&h<e;o++){if(h+n[o].weight>l)return n[o];h+=n[o].weight}return n[n.length-1]}class xe extends J{resizedData=S();adjustedData=S();index;constructor(t){super(),this.index=t}bind(t){super.bind(t),this.putImageData(this.adjustedData)}resizeCover(t,e){this.srcData.v&&T.resizeCover(t,e,this.srcData,this.resizedData)}adjust(){if(!this.resizedData.v)return;const t=m.getState().getConfig(this.index),e=S();t.isGray?T.toGray(this.resizedData,e):e.v=this.resizedData.v;const n=S();t.contrast!==0?T.adjustContrast(t.contrast,e,n):n.v=e.v,this.adjustedData.v=n.v}}class me extends J{resultData=S();inputCanvases=new Map;bind(t){super.bind(t),this.putImageData(this.resultData)}resize(t){for(const e of this.inputCanvases.values())e.resizeCover(t.width,t.height),e.adjust(),e.putImageData(e.adjustedData)}createInputCanvas(t){this.inputCanvases.has(t)||this.inputCanvases.set(t,new xe(t))}removeInputCanvas(t){this.inputCanvases.has(t)&&(this.inputCanvases.delete(t),v.getState().setHasInput(t,!1))}bindInputCanvas(t,e){this.inputCanvases.get(t)?.bind(e)}unbindInputCanvas(t){this.inputCanvases.get(t)?.unbind()}adjustInput(t){const e=this.inputCanvases.get(t);if(!e){console.error(`Input canvas for index ${t.toString()} does not exist.`);return}e.adjust(),e.putImageData(e.adjustedData)}setInputImage(t,e){const n=this.inputCanvases.get(e);if(!n)return console.error(`Input canvas for index ${e.toString()} does not exist.`),!1;n.setImage(t,!1);const l=m.getState().size;n.resizeCover(l.width,l.height),n.adjust(),n.putImageData(n.adjustedData);const o=v.getState().getHasInput(e);return v.getState().setHasInput(e,!0),!o}encode(){const t=l=>{console.error(l),this.resultData.v=null,v.setState({hasOutput:!1})},e=[];for(const[l,o]of this.inputCanvases.entries()){const h=m.getState().getConfig(l);o.adjustedData.v&&e.push({imageData:o.adjustedData.v,lowerThreshold:h.lowerThreshold,higherThreshold:h.higherThreshold,weight:h.weight})}if(e.length===0){t("No valid input images to encode.");return}if(T.matchSize({v:e[0].imageData},this.resultData),!this.resultData.v){t("Failed to create output image data.");return}if(!ge({inputs:e,output:this.resultData.v})){t("Failed to encode image.");return}this.putImageData(this.resultData),v.setState({hasOutput:!0})}encodeResultToFile(t){return this.encodeImageFile(this.resultData,t)}async saveResult(t){return this.saveImageFile(await this.encodeResultToFile(t),t)}}const p=new me,m=B()(U((a,t)=>({configs:{},indexes:[],size:{width:u.width,height:u.height},saveFormat:u.saveFormat,dontCareConflict:u.dontCareConflict,getMaxIndex:()=>{const e=t().indexes;return e.length>0?e[e.length-1]:-1},createConfig:()=>{const e=t().getMaxIndex()+1;p.createInputCanvas(e),a(n=>{n.indexes.push(e),n.configs[e]={lowerThreshold:u.lowerThreshold,higherThreshold:u.higherThreshold,contrast:u.contrast,isGray:u.isGray,weight:u.weight}})},getConfig:e=>t().configs[e]||{lowerThreshold:u.lowerThreshold,higherThreshold:u.higherThreshold,contrast:u.contrast,isGray:u.isGray,weight:u.weight},setConfigValue:(e,n,l)=>{a(o=>{if(o.configs[e])switch(n){case"lowerThreshold":case"higherThreshold":case"contrast":case"weight":o.configs[e][n]=Number(l);break;case"isGray":o.configs[e][n]=!!l;break}})},removeConfig:e=>{p.removeInputCanvas(e),a(n=>{delete n.configs[e],n.indexes=n.indexes.filter(l=>l!==e)})},setSize:(e,n)=>{a({size:{width:e,height:n}})},setDontCareConflict:e=>{a({dontCareConflict:e})},testConflict:()=>{const e=[];if(t().dontCareConflict)return!1;const n=t().configs;for(const o of v.getState().hasInput){const h=n[o];if(h){const{lowerThreshold:c,higherThreshold:d}=h;if(c>d)return!0;e.push({l:c,r:d})}}e.sort((o,h)=>o.l-h.l);let l=-1;for(const o of e){if(o.l<=l)return!0;l=o.r}return!1},setSaveFormat:e=>{a({saveFormat:e})}}))),v=B()(U((a,t)=>({hasOutput:!1,hasInput:new Set,setHasOutput:e=>{a({hasOutput:e})},setHasInput:(e,n)=>{a(l=>{n?l.hasInput.add(e):l.hasInput.delete(e)})},getHasInput:e=>t().hasInput.has(e)})));function pe(){const a=m(e=>e.indexes),t=m(e=>e.createConfig);x.useEffect(()=>{a.length===0&&t()},[a,t])}function Fe(){const a=L();return pe(),s.jsxs(f,{sx:{display:"flex",flexDirection:"column",width:"100%",maxWidth:a?"lg":"sm",mx:"auto",gap:1},children:[s.jsx(ve,{}),s.jsx(Ce,{}),s.jsxs(f,{sx:{display:"flex",flexDirection:"column",width:"100%",maxWidth:"sm",mx:"auto",gap:1},children:[s.jsx(Ie,{}),s.jsx(Se,{}),s.jsx(ye,{})]})]})}function ve(){const a=O(t=>t.setCurrentRoute);return s.jsxs(f,{sx:{display:"flex",flexDirection:"column",p:1,gap:1},children:[s.jsxs(C,{variant:"h6",color:"primary",children:[s.jsx("b",{children:"å¤åˆ"}),"å…‰æ£±å¦å…‹"]}),s.jsxs(C,{variant:"body1",children:["è¿™æ˜¯å…è®¸è¾“å…¥",s.jsx("b",{children:"è¶…è¿‡ä¸¤å¼ å›¾ç‰‡"}),'çš„æ¨¡å¼ ğŸ¤“ æ¨èåœ¨å¯¹"å…‰æ£±å¦å…‹"çš„åŸç†æœ‰åŸºç¡€çš„äº†è§£åå†ä½¿ç”¨ã€‚æˆ–è€…å¦‚æœæ‚¨æ°å·§ç†è§£èƒ½åŠ›è¶…ç¾¤ ğŸ§ ä¹Ÿå¯ä»¥è¾¹è¯•è¾¹å­¦â€”â€”æ‰€æœ‰çš„å›¾ç‰‡å‡åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°ç”Ÿæˆï¼Œæ²¡æœ‰äººä¼šæœ‰ä»»ä½•æ„è§ ğŸ˜‰']}),s.jsxs(C,{variant:"body1",children:["è¯·æ³¨æ„ï¼Œç”±äºæ¸²æŸ“çš„å¤æ‚æ€§ï¼Œæ­¤é¡µé¢",s.jsx("b",{children:"ä¸æä¾›"}),"ç»“æœçš„å®æ—¶é¢„è§ˆ ğŸ˜¥ æ›´æ–°å‚æ•°è¯·è®°å¾—æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®é‡æ–°ç”Ÿæˆ ğŸ™‚"]}),s.jsxs(C,{variant:"body1",children:["å¦å¤–ï¼Œç›¸è¾ƒ1.xç‰ˆæœ¬ï¼Œ",s.jsx(te,{component:"button",variant:"body1",onClick:()=>{a(M.decode)},children:"æ˜¾å½¢ç•Œé¢"})," ","çš„é˜ˆå€¼æ»‘æ¡å¤šäº†ä¸€ä¸ªç«¯ç‚¹ï¼Œè¿™æ­£æ˜¯ä¸ºæ˜¾å½¢å¤åˆå¦å…‹å‡†å¤‡çš„ ğŸ˜"]})]})}function Ce(){const a=L(),t=m(e=>e.indexes);return s.jsx(N,{container:!0,spacing:1,maxWidth:a?"lg":"sm",children:t.map(e=>s.jsx(N,{size:a?6:12,children:s.jsx(je,{index:e})},e))})}function je({index:a}){const t=R[a%R.length],e=v(n=>n.getHasInput(a));return s.jsx(ne,{primaryPaletteKey:t,children:s.jsx(_,{children:s.jsxs(f,{sx:{display:"flex",flexDirection:"row",width:"100%",gap:2,alignItems:"center"},children:[s.jsx(we,{index:a,hasImage:e}),s.jsx(De,{index:a,disabled:!e})]})})})}function we({index:a,hasImage:t}){const n=ie()?120:200,l=m(i=>i.createConfig),o=m(i=>i.removeConfig),h=x.useCallback(i=>{p.setInputImage(i,a)&&l()},[a,l]),c=()=>{t&&o(a)},d=x.useRef(null);return x.useEffect(()=>(p.bindInputCanvas(a,d.current),()=>{p.unbindInputCanvas(a)}),[a]),s.jsxs(f,{sx:{display:"flex",flexDirection:"column",gap:1,px:1,width:n},children:[s.jsx(he,{onconfirm:h,label:"åŠ è½½"}),!t&&s.jsx($,{text:"(ï½¥_ï½¥`)>",aspectRatio:"1",styles:{width:"100%",objectFit:"contain"}}),s.jsx("canvas",{ref:d,style:{maxWidth:n,maxHeight:n,display:t?"block":"none",objectFit:"contain"}}),s.jsx(I,{variant:"outlined",size:"small",sx:{width:"100%",border:"2px solid"},onClick:c,disabled:!t,children:"ç§»é™¤"})]})}function De({index:a,disabled:t}){const e=m(i=>i.getConfig(a)),n=m(i=>i.setConfigValue),l=i=>{n(a,"lowerThreshold",i)},o=i=>{n(a,"higherThreshold",i)},h=i=>{n(a,"contrast",i)},c=i=>{n(a,"isGray",i)},d=i=>{n(a,"weight",i)};return x.useEffect(()=>{p.adjustInput(a)},[a,e.contrast,e.lowerThreshold,e.higherThreshold,e.isGray]),s.jsxs(f,{sx:{flex:1,display:"flex",flexDirection:"column"},children:[s.jsxs(f,{sx:{display:"flex",flexDirection:"row",alignItems:"center"},children:[s.jsx(C,{variant:"body2",children:"1. è‰²é˜¶ç«¯ç‚¹:"}),s.jsx(f,{sx:{flex:1}}),s.jsx(y,{message:"å»ºè®®é¿å…å’Œå…¶ä»–è¾“å…¥å›¾ç‰‡çš„è‰²é˜¶é‡å "})]}),s.jsx(z,{value:[e.lowerThreshold,e.higherThreshold],min:0,max:255,step:u.thresholdStep,onChange:(i,r)=>{l(r[0]),o(r[1])},disabled:t}),s.jsxs(f,{sx:{display:"flex",flexDirection:"row",gap:1},children:[s.jsx(F,{value:e.lowerThreshold,inputProps:{step:u.thresholdStep,min:0,max:255,type:"number"},sx:{width:"80px"},onChange:i=>{const r=Number(i.target.value);isNaN(r)||l(r)},disabled:t}),s.jsx(F,{value:e.higherThreshold,inputProps:{step:u.thresholdStep,min:0,max:255,type:"number"},sx:{width:"80px"},onChange:i=>{const r=Number(i.target.value);isNaN(r)||o(r)},disabled:t})]}),s.jsxs(f,{sx:{mt:1,display:"flex",flexDirection:"row",alignItems:"center"},children:[s.jsx(C,{variant:"body2",children:"2. å¯¹æ¯”åº¦:"}),s.jsx(f,{sx:{flex:1}}),s.jsx(y,{message:"ä¸åˆç†çš„å¯¹æ¯”åº¦ä¼šä¸¥é‡é™ä½æ˜¾å½¢è´¨é‡"})]}),s.jsx(z,{value:e.contrast,min:P,max:E,step:u.contrastStep,onChange:(i,r)=>{h(r)},disabled:t}),s.jsxs(f,{sx:{display:"flex",flexDirection:"row",gap:1},children:[s.jsx(F,{value:e.contrast,inputProps:{step:u.contrastStep,min:P,max:E,type:"number"},sx:{width:"80px"},onChange:i=>{const r=Number(i.target.value);isNaN(r)||h(r)},disabled:t}),s.jsx(I,{size:"small",sx:{width:"80px"},onClick:()=>{h(0)},disabled:t,children:"é‡ç½®å¯¹æ¯”åº¦"})]}),s.jsxs(f,{sx:{mt:1,display:"flex",flexDirection:"row",alignItems:"center",gap:1},children:[s.jsx(C,{variant:"body2",children:"3. å–ç°åº¦:"}),s.jsx(de,{size:"medium",checked:e.isGray,onChange:i=>{c(i.target.checked)},disabled:t}),s.jsx(f,{sx:{flex:1}}),s.jsx(y,{message:"èˆå¼ƒé¢œè‰²å¯æ˜¾è‘—æå‡æŠ—å‹ç¼©èƒ½åŠ›"})]}),s.jsxs(f,{sx:{mt:1,display:"flex",flexDirection:"row",alignItems:"center",gap:1},children:[s.jsx(C,{variant:"body2",children:"4. æ··åˆæƒé‡:"}),s.jsx(z,{value:e.weight,min:1,max:4,step:1,onChange:(i,r)=>{d(r)},sx:{flex:1,ml:1,minWidth:"60px"},valueLabelDisplay:"auto",marks:!0,disabled:t}),s.jsx(f,{sx:{flex:1}}),s.jsx(y,{message:"æƒé‡è¶Šé«˜ï¼Œè¶Šå®¹æ˜“ç›´æ¥çœ‹å‡º"})]})]})}function Ie(){const a=m(i=>i.size),t=m(i=>i.setSize),[e,n]=x.useState(!1),[l,o]=x.useState(a.width),[h,c]=x.useState(a.height),d=x.useCallback((i,r)=>{n(!0);try{t(i,r),p.resize({width:i,height:r})}finally{n(!1)}},[t]);return s.jsxs(s.Fragment,{children:[e&&s.jsx(V,{}),s.jsx(_,{children:s.jsxs(oe,{sx:{display:"flex",flexDirection:"row",gap:1,width:"100%",alignItems:"center",justifyContent:"center"},children:[s.jsxs(f,{sx:{display:"flex",flexDirection:"column",gap:1},children:[s.jsxs(f,{sx:{display:"flex",flexDirection:"row",alignItems:"end",gap:1},children:[s.jsx(b,{children:"å½“å‰å®½åº¦:"}),s.jsx(G,{value:a.width,size:"small",variant:"standard",sx:{maxWidth:"60px"},disabled:!0}),s.jsx(b,{children:"æ–°å®½åº¦:"}),s.jsx(H,{initValue:l,onChange:o,size:"small",variant:"standard",sx:{maxWidth:"60px"},min:u.minSize,max:u.maxSize})]}),s.jsxs(f,{sx:{display:"flex",flexDirection:"row",alignItems:"end",gap:1},children:[" ",s.jsx(b,{children:"å½“å‰é«˜åº¦:"}),s.jsx(G,{value:a.height,size:"small",variant:"standard",sx:{maxWidth:"60px"},disabled:!0}),s.jsx(b,{children:"æ–°é«˜åº¦:"}),s.jsx(H,{initValue:h,onChange:c,size:"small",variant:"standard",sx:{maxWidth:"60px"},min:u.minSize,max:u.maxSize})]})]}),s.jsx(I,{sx:{aspectRatio:1,minWidth:0,padding:0,p:1},component:"label",onClick:()=>{d(l,h)},children:s.jsx(re,{})})]})})]})}function Se(){const[a,t]=x.useState(!1),e=v(r=>r.hasOutput),n=m(r=>r.testConflict),l=m(r=>r.dontCareConflict),o=m(r=>r.setDontCareConflict),[h,c]=x.useState(!1),d=x.useCallback(r=>{t(!0);try{if(!r&&n()){c(!0);return}p.encode()}finally{t(!1)}},[n]),i=x.useRef(null);return x.useEffect(()=>(p.bind(i.current),()=>{p.unbind()}),[]),s.jsxs(f,{sx:{display:"flex",flexDirection:"column",gap:1},children:[a&&s.jsx(V,{}),s.jsx(K,{show:h,onClose:()=>{c(!1)},onConfirm:()=>{c(!1),d(!0)},showWarning:!l,setShowWarning:r=>{o(!r)},title:"è‰²é˜¶åŒºé—´å­˜åœ¨å†²çªï¼",content:["å»ºè®®é¿å…è¾“å…¥å›¾ç‰‡çš„è‰²é˜¶ç«¯ç‚¹ä¹‹é—´å‘ç”Ÿé‡å ï¼Œå¦åˆ™æ˜¾å½¢æ•ˆæœå¯èƒ½ä¸å¦‚é¢„æœŸã€‚","ä¾‹å¦‚ 0-24 ä¸ 12-36 å­˜åœ¨é‡å , å»ºè®®è°ƒæ•´ä¸º 0-24 ä¸ 25-49ã€‚"]}),s.jsx(I,{variant:"contained",onClick:()=>{d(!1)},fullWidth:!0,children:"å…‰æ£±ï¼Œå¯åŠ¨ï¼"}),!e&&s.jsx($,{text:"åªæ˜¯ä¸€å¼ ç”»å¸ƒ",styles:{width:"100%",objectFit:"contain"}}),s.jsx("canvas",{ref:i,style:{maxWidth:"100%",maxHeight:"100%",display:e?"block":"none"}})]})}function ye(){const a=m(g=>g.saveFormat),t=m(g=>g.setSaveFormat),e=A(g=>g.showWarning),n=A(g=>g.setShowWarning),[l,o]=x.useState(!1),h=se(g=>g.setImages),c=O(g=>g.setCurrentRoute),[d,i]=x.useState(!1),r=x.useCallback((g,j)=>{if(!j&&g!=="JPEG"&&e){o(!0);return}i(!0),p.saveResult(g).then(w=>{ae(`å·²ä¿å­˜ä¸º ${w}`)}).catch(w=>{console.error("Failed to save result:",w),W("ä¿å­˜å¤±è´¥")}).finally(()=>{i(!1)})},[e]),D=x.useCallback(g=>{i(!0),(async()=>{const j=await p.encodeResultToFile(g),w=await le.fromFileData(j);h([w]),c(M.decode)})().catch(j=>{console.error("Failed to encode result:",j),W("è·³è½¬å¤±è´¥")}).finally(()=>{i(!1)})},[h,c]);return s.jsxs(f,{sx:{width:"100%",display:"flex",flexDirection:"row",gap:1},children:[s.jsx(K,{show:l,onClose:()=>{o(!1)},onConfirm:()=>{o(!1),r(a,!0)},showWarning:e,setShowWarning:n,title:`ç¡®è®¤ä¿å­˜ä¸º ${a}?`,content:["é JPEG æ ¼å¼å¯èƒ½ä¼šè¢«æŸäº›ç¤¾äº¤å¹³å°å¼ºåˆ¶å‹ç¼©ï¼Œè¿™å°†ä¸¥é‡å½±å“æ˜¾å½¢æ•ˆæœã€‚è¯·è°¨æ…é€‰æ‹©ã€‚"]}),s.jsx(I,{sx:{flex:1},variant:"contained",onClick:()=>{r(a,!1)},disabled:d,children:"ä¿å­˜ç»“æœ"}),s.jsx(I,{sx:{flex:1},variant:"contained",color:"secondary",onClick:()=>{D(a)},disabled:d,children:"æ˜¾å½¢æµ‹è¯•"}),s.jsx(ce,{format:a,onChange:g=>{t(g)},disabled:d}),s.jsx(y,{message:"é JPEG æ ¼å¼æœ‰è¾ƒé«˜çš„è¢«ç¤¾äº¤å¹³å°å¼ºåˆ¶å‹ç¼©çš„é£é™©"})]})}export{Fe as default};
