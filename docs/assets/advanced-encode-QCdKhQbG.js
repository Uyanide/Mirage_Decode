import{K as Z,C as B,r as x,M as u,g as L,j as s,B as g,H as O,T as j,N as ee,I as M,L as V,b as I,c as te,a as se,f as R,S as ae,P as W,J as ne,m as E,h as G}from"./index-CnziIsRy.js";import{b as _,n as y,a as T,c as J,j as ie,k as b,T as P,l as re,C as $,P as oe,F as le,H as S,I as ce,S as z,d as F}from"./format-selector-B6UaPIIp.js";import{G as N,N as H,u as A,F as he,a as de}from"./format-warn-dialog-BK6nkCON.js";const ue=a=>(t,e,n)=>(n.setState=(o,i,...h)=>{const c=typeof o=="function"?Z(o):o;return t(c,i,...h)},a(n.setState,e,n)),K=ue;function ge({inputs:a,output:t}){if(a.length===0)return console.error("No input images provided for encoding."),!1;const e=a[0].imageData.width,n=a[0].imageData.height,o=a[0].imageData.data.length;for(const c of a)if(c.imageData.width!==e||c.imageData.height!==n)return console.error("All input images must have the same dimensions."),!1;if(t.width!==e||t.height!==n)return console.error("Output image must have the same dimensions as input images."),!1;const i=t.data,h=a.reduce((c,r)=>c+r.weight,0);for(let c=0,r=0,l=0;c<o;c+=4){const m=xe(r,l,h,a),D=m.lowerThreshold,d=m.higherThreshold,C=m.imageData.data[c],w=m.imageData.data[c+1],U=m.imageData.data[c+2],q=m.imageData.data[c+3],Q=k(C,D,d),X=k(w,D,d),Y=k(U,D,d);i[c]=Q,i[c+1]=X,i[c+2]=Y,i[c+3]=q,r++,r>=e&&(r=0,l++)}return!0}function k(a,t,e){return Math.floor(Math.max(t,Math.min(a*(e-t)/255+t,e)))}function xe(a,t,e,n){const o=(a+t)%e;for(let i=0,h=0;i<n.length&&h<e;i++){if(h+n[i].weight>o)return n[i];h+=n[i].weight}return n[n.length-1]}class fe extends _{resizedData=y();adjustedData=y();index;constructor(t){super(),this.index=t}bind(t){super.bind(t),this.putImageData(this.adjustedData)}resizeCover(t,e){this.srcData.v&&T.resizeCover(t,e,this.srcData,this.resizedData)}adjust(){if(!this.resizedData.v)return;const t=f.getState().getConfig(this.index),e=y();t.isGray?T.toGray(this.resizedData,e):e.v=this.resizedData.v;const n=y();t.contrast!==0?T.adjustContrast(t.contrast,e,n):n.v=e.v,this.adjustedData.v=n.v}}class me extends _{resultData=y();inputCanvases=new Map;bind(t){super.bind(t),this.putImageData(this.resultData)}resize(t){for(const e of this.inputCanvases.values())e.resizeCover(t.width,t.height),e.adjust()}createInputCanvas(t){this.inputCanvases.has(t)||this.inputCanvases.set(t,new fe(t))}removeInputCanvas(t){this.inputCanvases.has(t)&&(this.inputCanvases.delete(t),v.getState().setHasInput(t,!1))}bindInputCanvas(t,e){this.inputCanvases.get(t)?.bind(e)}unbindInputCanvas(t){this.inputCanvases.get(t)?.unbind()}adjustInput(t){const e=this.inputCanvases.get(t);if(!e){console.error(`Input canvas for index ${t.toString()} does not exist.`);return}e.adjust(),e.putImageData(e.adjustedData)}setInputImage(t,e){const n=this.inputCanvases.get(e);if(!n)return console.error(`Input canvas for index ${e.toString()} does not exist.`),!1;n.setImage(t,!1);const o=f.getState().size;n.resizeCover(o.width,o.height),n.adjust(),n.putImageData(n.adjustedData);const i=v.getState().getHasInput(e);return v.getState().setHasInput(e,!0),!i}encode(){const t=o=>{console.error(o),this.resultData.v=null,v.setState({hasOutput:!1})},e=[];for(const[o,i]of this.inputCanvases.entries()){const h=f.getState().getConfig(o);i.adjustedData.v&&e.push({imageData:i.adjustedData.v,lowerThreshold:h.lowerThreshold,higherThreshold:h.higherThreshold,weight:h.weight})}if(e.length===0){t("No valid input images to encode.");return}if(T.matchSize({v:e[0].imageData},this.resultData),!this.resultData.v){t("Failed to create output image data.");return}if(!ge({inputs:e,output:this.resultData.v})){t("Failed to encode image.");return}this.putImageData(this.resultData),v.setState({hasOutput:!0})}encodeResultToFile(t){return this.encodeImageFile(this.resultData,t)}async saveResult(t){return this.saveImageFile(await this.encodeResultToFile(t),t)}}const p=new me,f=B()(K((a,t)=>({configs:{},indexes:[],size:{width:u.width,height:u.height},saveFormat:u.saveFormat,getMaxIndex:()=>{const e=t().indexes;return e.length>0?e[e.length-1]:-1},createConfig:()=>{const e=t().getMaxIndex()+1;p.createInputCanvas(e),a(n=>{n.indexes.push(e),n.configs[e]={lowerThreshold:u.lowerThreshold,higherThreshold:u.higherThreshold,contrast:u.contrast,isGray:u.isGray,weight:u.weight}})},getConfig:e=>t().configs[e]||{lowerThreshold:u.lowerThreshold,higherThreshold:u.higherThreshold,contrast:u.contrast,isGray:u.isGray,weight:u.weight},setConfigValue:(e,n,o)=>{a(i=>{if(i.configs[e])switch(n){case"lowerThreshold":case"higherThreshold":case"contrast":case"weight":i.configs[e][n]=Number(o);break;case"isGray":i.configs[e][n]=!!o;break}})},removeConfig:e=>{p.removeInputCanvas(e),a(n=>{delete n.configs[e],n.indexes=n.indexes.filter(o=>o!==e)})},setSize:(e,n)=>{a({size:{width:e,height:n}})},testConflict:()=>{const e=[],n=t().configs;for(const i of v.getState().hasInput){const h=n[i];if(h){const{lowerThreshold:c,higherThreshold:r}=h;if(c>r)return!0;e.push({l:c,r})}}e.sort((i,h)=>i.l-h.l);let o=-1;for(const i of e){if(i.l<o)return!0;o=i.r}return!1},setSaveFormat:e=>{a({saveFormat:e})}}))),v=B()(K((a,t)=>({hasOutput:!1,hasInput:new Set,setHasOutput:e=>{a({hasOutput:e})},setHasInput:(e,n)=>{a(o=>{n?o.hasInput.add(e):o.hasInput.delete(e)})},getHasInput:e=>t().hasInput.has(e)})));function pe(){const a=f(e=>e.indexes),t=f(e=>e.createConfig);x.useEffect(()=>{a.length===0&&t()},[a,t])}function Fe(){const a=L();return pe(),s.jsxs(g,{sx:{display:"flex",flexDirection:"column",width:"100%",maxWidth:a?"lg":"sm",mx:"auto",gap:1},children:[s.jsx(ve,{}),s.jsx(je,{}),s.jsxs(g,{sx:{display:"flex",flexDirection:"column",width:"100%",maxWidth:"sm",mx:"auto",gap:1},children:[s.jsx(De,{}),s.jsx(ye,{}),s.jsx(Se,{})]})]})}function ve(){const a=O(t=>t.setCurrentRoute);return s.jsxs(g,{sx:{display:"flex",flexDirection:"column",p:1,gap:1},children:[s.jsxs(j,{variant:"h6",color:"primary",children:[s.jsx("b",{children:"复合"}),"光棱坦克"]}),s.jsxs(j,{variant:"body1",children:["这是允许输入",s.jsx("b",{children:"超过两张图片"}),'的模式 🤓 推荐在对"光棱坦克"的原理有基础的了解后再使用。或者如果您恰巧理解能力超群 🧐 也可以边试边学——所有的图片均在您的浏览器本地生成，没有人会有任何意见 😉']}),s.jsx(j,{variant:"body1",children:"在成功加载一张图片后，会有新的图片输入框出现以便您添加更多图片。同理，移除一张图片也会相应地移除它所属的输入框。很直接的交互方式，不是吗 😊"}),s.jsxs(j,{variant:"body1",children:["另外，相较1.x版本，",s.jsx(ee,{component:"button",variant:"body1",onClick:()=>{a(M.decode)},children:"显形界面"})," ","的阈值滑条多了一个端点，这就是为显形复合坦克准备的 😎"]})]})}function je(){const a=L(),t=f(e=>e.indexes);return s.jsx(N,{container:!0,spacing:2,maxWidth:a?"lg":"sm",children:t.map(e=>s.jsx(N,{size:a?6:12,children:s.jsx(Ce,{index:e})},e))})}function Ce({index:a}){const t=W[a%W.length];return s.jsx(ae,{primaryPaletteKey:t,children:s.jsx(J,{children:s.jsxs(g,{sx:{display:"flex",flexDirection:"row",width:"100%",gap:2,alignItems:"center"},children:[s.jsx(we,{index:a}),s.jsx(Ie,{index:a})]})})})}function we({index:a}){const e=ne()?120:200,n=f(l=>l.createConfig),o=f(l=>l.removeConfig),i=v(l=>l.getHasInput(a)),h=x.useCallback(l=>{p.setInputImage(l,a)&&n()},[a,n]),c=()=>{i&&o(a)},r=x.useRef(null);return x.useEffect(()=>(p.bindInputCanvas(a,r.current),()=>{p.unbindInputCanvas(a)}),[a]),s.jsxs(g,{sx:{display:"flex",flexDirection:"column",gap:1,px:1,width:e},children:[s.jsx(ce,{onconfirm:h,label:"加载"}),!i&&s.jsx($,{text:"(･_･`)>",aspectRatio:"1",styles:{width:"100%",objectFit:"contain"}}),s.jsx("canvas",{ref:r,style:{maxWidth:e,maxHeight:e,display:i?"block":"none",objectFit:"contain"}}),s.jsx(I,{variant:"outlined",size:"small",sx:{width:"100%",border:"2px solid"},onClick:c,disabled:!i,children:"移除"})]})}function Ie({index:a}){const t=f(r=>r.getConfig(a)),e=f(r=>r.setConfigValue),n=r=>{e(a,"lowerThreshold",r)},o=r=>{e(a,"higherThreshold",r)},i=r=>{e(a,"contrast",r)},h=()=>{e(a,"isGray",!t.isGray)},c=r=>{e(a,"weight",r)};return x.useEffect(()=>{p.adjustInput(a)},[a,t.contrast,t.lowerThreshold,t.higherThreshold,t.isGray]),s.jsxs(g,{sx:{flex:1,display:"flex",flexDirection:"column"},children:[s.jsxs(g,{sx:{display:"flex",flexDirection:"row",alignItems:"center"},children:[s.jsx(j,{variant:"body2",children:"1. 色阶端点:"}),s.jsx(g,{sx:{flex:1}}),s.jsx(S,{message:"建议避免和其他输入图片的色阶重叠"})]}),s.jsx(z,{value:[t.lowerThreshold,t.higherThreshold],min:0,max:255,step:u.thresholdStep,onChange:(r,l)=>{n(l[0]),o(l[1])}}),s.jsxs(g,{sx:{display:"flex",flexDirection:"row",gap:1},children:[s.jsx(F,{value:t.lowerThreshold,inputProps:{step:u.thresholdStep,min:0,max:255,type:"number"},sx:{width:"80px"},onChange:r=>{const l=Number(r.target.value);isNaN(l)||n(l)}}),s.jsx(F,{value:t.higherThreshold,inputProps:{step:u.thresholdStep,min:0,max:255,type:"number"},sx:{width:"80px"},onChange:r=>{const l=Number(r.target.value);isNaN(l)||o(l)}})]}),s.jsxs(g,{sx:{mt:1,display:"flex",flexDirection:"row",alignItems:"center"},children:[s.jsx(j,{variant:"body2",children:"2. 对比度:"}),s.jsx(g,{sx:{flex:1}}),s.jsx(S,{message:"不合理的对比度会严重降低显形质量"})]}),s.jsx(z,{value:t.contrast,min:G,max:E,step:u.contrastStep,onChange:(r,l)=>{i(l)}}),s.jsxs(g,{sx:{display:"flex",flexDirection:"row",gap:1},children:[s.jsx(F,{value:t.contrast,inputProps:{step:u.contrastStep,min:G,max:E,type:"number"},sx:{width:"80px"},onChange:r=>{const l=Number(r.target.value);isNaN(l)||i(l)}}),s.jsx(I,{size:"small",sx:{width:"80px"},onClick:()=>{i(0)},children:"重置对比度"})]}),s.jsxs(g,{sx:{mt:1,display:"flex",flexDirection:"row",alignItems:"center",gap:1},children:[s.jsx(j,{variant:"body2",children:"3. 取灰度:"}),s.jsx(de,{size:"medium",value:t.isGray,onClick:h}),s.jsx(g,{sx:{flex:1}}),s.jsx(S,{message:"舍弃颜色可显著提升抗压缩能力"})]}),s.jsxs(g,{sx:{mt:1,display:"flex",flexDirection:"row",alignItems:"center",gap:1},children:[s.jsx(j,{variant:"body2",children:"4. 混合权重:"}),s.jsx(z,{value:t.weight,min:1,max:4,step:1,onChange:(r,l)=>{c(l)},sx:{flex:1,ml:1,minWidth:"60px"},valueLabelDisplay:"auto",marks:!0}),s.jsx(g,{sx:{flex:1}}),s.jsx(S,{message:"权重越高，越容易直接看出"})]})]})}function De(){const a=f(l=>l.size),t=f(l=>l.setSize),[e,n]=x.useState(!1),[o,i]=x.useState(a.width),[h,c]=x.useState(a.height),r=x.useCallback((l,m)=>{n(!0);try{t(l,m),p.resize({width:l,height:m})}finally{n(!1)}},[t]);return s.jsxs(s.Fragment,{children:[e&&s.jsx(V,{}),s.jsx(J,{children:s.jsxs(ie,{sx:{display:"flex",flexDirection:"row",gap:1,width:"100%",alignItems:"center",justifyContent:"center"},children:[s.jsxs(g,{sx:{display:"flex",flexDirection:"column",gap:1},children:[s.jsxs(g,{sx:{display:"flex",flexDirection:"row",alignItems:"end",gap:1},children:[s.jsx(b,{children:"当前宽度:"}),s.jsx(P,{value:a.width,size:"small",variant:"standard",sx:{maxWidth:"60px"},disabled:!0}),s.jsx(b,{children:"新宽度:"}),s.jsx(H,{initValue:o,onChange:i,size:"small",variant:"standard",sx:{maxWidth:"60px"},min:u.minSize,max:u.maxSize})]}),s.jsxs(g,{sx:{display:"flex",flexDirection:"row",alignItems:"end",gap:1},children:[" ",s.jsx(b,{children:"当前高度:"}),s.jsx(P,{value:a.height,size:"small",variant:"standard",sx:{maxWidth:"60px"},disabled:!0}),s.jsx(b,{children:"新高度:"}),s.jsx(H,{initValue:h,onChange:c,size:"small",variant:"standard",sx:{maxWidth:"60px"},min:u.minSize,max:u.maxSize})]})]}),s.jsx(I,{sx:{aspectRatio:1,minWidth:0,padding:0,p:1},component:"label",onClick:()=>{r(o,h)},children:s.jsx(re,{})})]})})]})}function ye(){const[a,t]=x.useState(!1),e=v(i=>i.hasOutput),n=x.useCallback(()=>{t(!0);try{p.encode()}finally{t(!1)}},[]),o=x.useRef(null);return x.useEffect(()=>(p.bind(o.current),()=>{p.unbind()}),[]),s.jsxs(g,{sx:{display:"flex",flexDirection:"column",gap:1},children:[a&&s.jsx(V,{}),s.jsx(I,{variant:"contained",onClick:n,fullWidth:!0,children:"光棱，启动！"}),!e&&s.jsx($,{text:"只是一张画布",styles:{width:"100%",objectFit:"contain"}}),s.jsx("canvas",{ref:o,style:{maxWidth:"100%",maxHeight:"100%",display:e?"block":"none"}})]})}function Se(){const a=f(d=>d.saveFormat),t=f(d=>d.setSaveFormat),e=A(d=>d.showWarning),n=A(d=>d.setShowWarning),[o,i]=x.useState(!1),h=te(d=>d.setImages),c=O(d=>d.setCurrentRoute),[r,l]=x.useState(!1),m=x.useCallback((d,C)=>{if(!C&&d!=="JPEG"&&e){i(!0);return}l(!0),p.saveResult(d).then(w=>{se(`已保存为 ${w}`)}).catch(w=>{console.error("Failed to save result:",w),R("保存失败")}).finally(()=>{l(!1)})},[e]),D=x.useCallback(d=>{l(!0),(async()=>{const C=await p.encodeResultToFile(d),w=await oe.fromFileData(C);h([w]),c(M.decode)})().catch(C=>{console.error("Failed to encode result:",C),R("跳转失败")}).finally(()=>{l(!1)})},[h,c]);return s.jsxs(g,{sx:{width:"100%",display:"flex",flexDirection:"row",gap:1},children:[s.jsx(he,{show:o,setShow:i,saveFormat:a,handleSave:m,showWarning:e,setShowWarning:n}),s.jsx(I,{sx:{flex:1},variant:"contained",onClick:()=>{m(a,!1)},disabled:r,children:"保存结果"}),s.jsx(I,{sx:{flex:1},variant:"contained",color:"secondary",onClick:()=>{D(a)},disabled:r,children:"显形测试"}),s.jsx(le,{format:a,onChange:d=>{t(d)},disabled:r}),s.jsx(S,{message:"非 JPEG 格式有较高地被社交平台强制压缩的风险"})]})}export{Fe as default};
