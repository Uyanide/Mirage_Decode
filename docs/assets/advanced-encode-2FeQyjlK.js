import{R as Q,n as D,d as q,I as T,J as L,r as x,S as h,h as B,j as t,B as d,P as O,T as v,U as X,Q as V,L as M,b as w,c as Y,a as Z,g as z,V as ee,W,M as te,m as R,i as E}from"./index-BEVIlbuW.js";import{a as N,G,b as J,g as se,h as b,T as P,e as H,i as ae,C as _,P as $,F as ne,H as y,L as ie,I as re,D as oe,S as F,N as k}from"./number-input-Crrw1peN.js";import{W as U,u as A,a as le}from"./warn-dialog-BAega6ET.js";const ce=a=>(s,e,n)=>(n.setState=(r,o,...c)=>{const f=typeof r=="function"?Q(r):r;return s(f,o,...c)},a(n.setState,e,n)),K=ce;class he extends N{resizedData=D();adjustedData=D();index;constructor(s){super(),this.index=s}bind(s){super.bind(s),this.putImageData(this.adjustedData)}resizeCover(s,e){this.srcData.v&&T.resizeCover(s,e,this.srcData,this.resizedData)}adjust(){if(!this.resizedData.v)return;const s=g.getState().getConfig(this.index),e=D();s.isGray?T.toGray(this.resizedData,e):e.v=this.resizedData.v;const n=D();s.contrast!==0?T.adjustContrast(s.contrast,e,n):n.v=e.v,this.adjustedData.v=n.v}}class de extends N{resultData=D();inputCanvases=new Map;bind(s){super.bind(s),this.putImageData(this.resultData)}resize(s){for(const e of this.inputCanvases.values())e.resizeCover(s.width,s.height),e.adjust(),e.putImageData(e.adjustedData)}createInputCanvas(s){this.inputCanvases.has(s)||this.inputCanvases.set(s,new he(s))}removeInputCanvas(s){this.inputCanvases.has(s)&&(this.inputCanvases.delete(s),C.getState().setHasInput(s,!1))}bindInputCanvas(s,e){this.inputCanvases.get(s)?.bind(e)}unbindInputCanvas(s){this.inputCanvases.get(s)?.unbind()}adjustInput(s){const e=this.inputCanvases.get(s);if(!e){console.error(`Input canvas for index ${s.toString()} does not exist.`);return}e.adjust(),e.putImageData(e.adjustedData)}setInputImage(s,e){const n=this.inputCanvases.get(e);if(!n)return console.error(`Input canvas for index ${e.toString()} does not exist.`),!1;n.setImage(s,!1);const r=g.getState().size;n.resizeCover(r.width,r.height),n.adjust(),n.putImageData(n.adjustedData);const o=C.getState().getHasInput(e);return C.getState().setHasInput(e,!0),!o}encode(){const s=r=>{console.error(r),this.resultData.v=null,C.setState({hasOutput:!1})},e=[];for(const[r,o]of this.inputCanvases.entries()){const c=g.getState().getConfig(r);o.adjustedData.v&&e.push({imageData:o.adjustedData.v,lowerThreshold:c.lowerThreshold,higherThreshold:c.higherThreshold,weight:c.weight})}if(e.length===0){s("No valid input images to encode.");return}if(q.matchSize({v:e[0].imageData},this.resultData),!this.resultData.v){s("Failed to create output image data.");return}if(!T.prismAdvancedEncode({inputs:e,output:this.resultData.v})){s("Failed to encode image.");return}this.putImageData(this.resultData),C.setState({hasOutput:!0})}encodeResultToFile(s){return this.encodeImageFile(this.resultData,s)}async saveResult(s){return this.saveImageFile(await this.encodeResultToFile(s),s)}}const p=new de,g=L()(K((a,s)=>({configs:{},indexes:[],size:{width:h.width,height:h.height},saveFormat:h.saveFormat,dontCareConflict:h.dontCareConflict,getMaxIndex:()=>{const e=s().indexes;return e.length>0?e[e.length-1]:-1},createConfig:()=>{const e=s().getMaxIndex();let n=h.thresholdStart;e>=0&&(n=s().configs[e].higherThreshold+h.thresholdGap);let r=n+h.thresholdWidth;r>255&&(r=255),n>=r&&(n=h.thresholdStart,r=n+h.thresholdWidth);const o=s().getMaxIndex()+1;p.createInputCanvas(o),a(c=>{c.indexes.push(o),c.configs[o]={lowerThreshold:n,higherThreshold:r,contrast:h.contrast,isGray:h.isGray,weight:h.weight}})},getConfig:e=>s().configs[e]||{lowerThreshold:h.thresholdStart,higherThreshold:h.thresholdStart+h.thresholdWidth,contrast:h.contrast,isGray:h.isGray,weight:h.weight},setConfigValue:(e,n,r)=>{a(o=>{if(o.configs[e])switch(n){case"lowerThreshold":case"higherThreshold":case"contrast":case"weight":o.configs[e][n]=Number(r);break;case"isGray":o.configs[e][n]=!!r;break}})},removeConfig:e=>{p.removeInputCanvas(e),a(n=>{delete n.configs[e],n.indexes=n.indexes.filter(r=>r!==e)})},setSize:(e,n)=>{a({size:{width:e,height:n}})},setDontCareConflict:e=>{a({dontCareConflict:e})},testConflict:()=>{const e=[];if(s().dontCareConflict)return!1;const n=s().configs;for(const o of C.getState().hasInput){const c=n[o];if(c){const{lowerThreshold:f,higherThreshold:m}=c;if(f>m)return!0;e.push({l:f,r:m})}}e.sort((o,c)=>o.l-c.l);let r=-1;for(const o of e){if(o.l<=r)return!0;r=o.r}return!1},setSaveFormat:e=>{a({saveFormat:e})}}))),C=L()(K((a,s)=>({hasOutput:!1,hasInput:new Set,setHasOutput:e=>{a({hasOutput:e})},setHasInput:(e,n)=>{a(r=>{n?r.hasInput.add(e):r.hasInput.delete(e)})},getHasInput:e=>s().hasInput.has(e)})));function ue(){const a=g(e=>e.indexes),s=g(e=>e.createConfig);x.useEffect(()=>{a.length===0&&s()},[a,s])}function De(){const a=B();return ue(),t.jsxs(d,{sx:{display:"flex",flexDirection:"column",width:"100%",maxWidth:a?"lg":"sm",mx:"auto",gap:1},children:[t.jsx(xe,{}),t.jsx(fe,{}),t.jsxs(d,{sx:{display:"flex",flexDirection:"column",width:"100%",maxWidth:"sm",mx:"auto",gap:1},children:[t.jsx(Ce,{}),t.jsx(ve,{}),t.jsx(je,{})]})]})}function xe(){const a=O(s=>s.setCurrentRoute);return t.jsxs(d,{sx:{display:"flex",flexDirection:"column",p:1,gap:1},children:[t.jsxs(v,{variant:"h6",color:"primary",children:[t.jsx("b",{children:"å¤åˆ"}),"å…‰æ£±å¦å…‹"]}),t.jsxs(v,{variant:"body1",children:["è¿™æ˜¯å…è®¸è¾“å…¥",t.jsx("b",{children:"è¶…è¿‡ä¸¤å¼ å›¾ç‰‡"}),'çš„æ¨¡å¼ ğŸ¤“ æ¨èåœ¨å¯¹"å…‰æ£±å¦å…‹"çš„åŸç†æœ‰åŸºç¡€çš„äº†è§£åå†ä½¿ç”¨ã€‚æˆ–è€…å¦‚æœæ‚¨æ°å·§ç†è§£èƒ½åŠ›è¶…ç¾¤ ğŸ§ ä¹Ÿå¯ä»¥è¾¹è¯•è¾¹å­¦â€”â€”æ‰€æœ‰çš„å›¾ç‰‡å‡åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°ç”Ÿæˆï¼Œæ²¡æœ‰äººä¼šæœ‰ä»»ä½•æ„è§ ğŸ˜‰']}),t.jsxs(v,{variant:"body1",children:["è¯·æ³¨æ„ï¼Œç”±äºæ¸²æŸ“çš„å¤æ‚æ€§ï¼Œæ­¤é¡µé¢æš‚æ—¶",t.jsx("b",{children:"ä¸æä¾›"}),"ç»“æœçš„å®æ—¶é¢„è§ˆ ğŸ˜¥ æ›´æ–°å‚æ•°åè¯·è®°å¾—æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®é‡æ–°ç”Ÿæˆ ğŸ™‚"]}),t.jsxs(v,{variant:"body1",children:["å¦å¤–ï¼Œç›¸è¾ƒ1.xç‰ˆæœ¬ï¼Œ",t.jsx(X,{component:"button",variant:"body1",onClick:()=>{a(V.decode)},children:"æ˜¾å½¢ç•Œé¢"})," ","çš„é˜ˆå€¼æ»‘æ¡å¤šäº†ä¸€ä¸ªç«¯ç‚¹ï¼Œè¿™æ­£æ˜¯ä¸ºæ˜¾å½¢å¤åˆå¦å…‹å‡†å¤‡çš„ ğŸ˜"]})]})}function fe(){const a=B(),s=g(e=>e.indexes);return t.jsx(G,{container:!0,spacing:1,maxWidth:a?"lg":"sm",children:s.map(e=>t.jsx(G,{size:a?6:12,children:t.jsx(ge,{index:e})},e))})}function ge({index:a}){const s=W[a%W.length],e=C(n=>n.getHasInput(a));return t.jsx(ee,{primaryPaletteKey:s,children:t.jsx(J,{children:t.jsxs(d,{sx:{display:"flex",flexDirection:"row",width:"100%",gap:2,alignItems:"center"},children:[t.jsx(me,{index:a,hasImage:e}),t.jsx(pe,{index:a,disabled:!1})]})})})}function me({index:a,hasImage:s}){const n=te()?120:200,r=g(l=>l.createConfig),o=g(l=>l.removeConfig),c=x.useCallback(l=>{p.setInputImage(l,a)&&r()},[a,r]),f=()=>{s&&o(a)},m=x.useCallback(l=>{(async()=>{const j=await ie.fromDropItems(l,!1);if(j.length===0){z("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡");return}const u=await $.fromFileData(j[0]);c(u)})().catch(j=>{z("åŠ è½½å›¾ç‰‡å¤±è´¥"),console.error(j)})},[c]),i=x.useRef(null);return x.useEffect(()=>(p.bindInputCanvas(a,i.current),()=>{p.unbindInputCanvas(a)}),[a]),t.jsxs(d,{sx:{display:"flex",flexDirection:"column",gap:1,px:1,width:n},children:[t.jsx(re,{onconfirm:c,label:"åŠ è½½"}),t.jsxs(oe,{onDrop:m,children:[!s&&t.jsx(_,{text:"(ï½¥_ï½¥`)>",aspectRatio:"1",styles:{width:"100%",objectFit:"contain"}}),t.jsx("canvas",{ref:i,style:{width:"100%",maxWidth:n,maxHeight:n,display:s?"block":"none",objectFit:"contain"}})]}),t.jsx(w,{variant:"outlined",size:"small",sx:{width:"100%",border:"2px solid"},onClick:f,disabled:!s,children:"ç§»é™¤"})]})}function pe({index:a,disabled:s}){const e=g(i=>i.getConfig(a)),n=g(i=>i.setConfigValue),r=i=>{n(a,"lowerThreshold",i)},o=i=>{n(a,"higherThreshold",i)},c=i=>{n(a,"contrast",i)},f=i=>{n(a,"isGray",i)},m=i=>{n(a,"weight",i)};return x.useEffect(()=>{p.adjustInput(a)},[a,e.contrast,e.lowerThreshold,e.higherThreshold,e.isGray]),t.jsxs(d,{sx:{flex:1,display:"flex",flexDirection:"column"},children:[t.jsxs(d,{sx:{display:"flex",flexDirection:"row",alignItems:"center"},children:[t.jsx(v,{variant:"body2",children:"1. è‰²é˜¶ç«¯ç‚¹:"}),t.jsx(d,{sx:{flex:1}}),t.jsx(y,{message:"å»ºè®®é¿å…å’Œå…¶ä»–è¾“å…¥å›¾ç‰‡çš„è‰²é˜¶é‡å "})]}),t.jsx(F,{value:[e.lowerThreshold,e.higherThreshold],min:0,max:255,step:h.thresholdStep,onChange:(i,l)=>{r(l[0]),o(l[1])},disabled:s}),t.jsxs(d,{sx:{display:"flex",flexDirection:"row",gap:1},children:[t.jsx(k,{realValue:e.lowerThreshold,onSubmit:i=>{r(i)},min:0,max:e.higherThreshold,step:h.thresholdStep,sx:{width:"80px"},disabled:s,variant:"standard"}),t.jsx(k,{realValue:e.higherThreshold,onSubmit:i=>{o(i)},min:e.lowerThreshold,max:255,step:h.thresholdStep,sx:{width:"80px"},disabled:s,variant:"standard"})]}),t.jsxs(d,{sx:{mt:1,display:"flex",flexDirection:"row",alignItems:"center"},children:[t.jsx(v,{variant:"body2",children:"2. å¯¹æ¯”åº¦:"}),t.jsx(d,{sx:{flex:1}}),t.jsx(y,{message:"ä¸åˆç†çš„å¯¹æ¯”åº¦ä¼šä¸¥é‡é™ä½æ˜¾å½¢è´¨é‡"})]}),t.jsx(F,{value:e.contrast,min:E,max:R,step:h.contrastStep,onChange:(i,l)=>{c(l)},disabled:s}),t.jsxs(d,{sx:{display:"flex",flexDirection:"row",gap:1},children:[t.jsx(k,{realValue:e.contrast,onSubmit:i=>{c(i)},min:E,max:R,step:h.contrastStep,sx:{width:"80px"},disabled:s,variant:"standard"}),t.jsx(w,{size:"small",sx:{width:"80px"},onClick:()=>{c(0)},disabled:s,children:"é‡ç½®å¯¹æ¯”åº¦"})]}),t.jsxs(d,{sx:{mt:1,display:"flex",flexDirection:"row",alignItems:"center",gap:1},children:[t.jsx(v,{variant:"body2",children:"3. å–ç°åº¦:"}),t.jsx(le,{size:"medium",checked:e.isGray,onChange:i=>{f(i.target.checked)},disabled:s}),t.jsx(d,{sx:{flex:1}}),t.jsx(y,{message:"èˆå¼ƒé¢œè‰²å¯æ˜¾è‘—æå‡æŠ—å‹ç¼©èƒ½åŠ›"})]}),t.jsxs(d,{sx:{mt:1,display:"flex",flexDirection:"row",alignItems:"center",gap:1},children:[t.jsx(v,{variant:"body2",children:"4. æ··åˆæƒé‡:"}),t.jsx(F,{value:e.weight,min:1,max:4,step:1,onChange:(i,l)=>{m(l)},sx:{flex:1,ml:1,minWidth:"60px"},valueLabelDisplay:"auto",marks:!0,disabled:s}),t.jsx(d,{sx:{flex:1}}),t.jsx(y,{message:"æƒé‡è¶Šé«˜ï¼Œè¶Šå®¹æ˜“ç›´æ¥çœ‹å‡º"})]})]})}function Ce(){const a=g(i=>i.size),s=g(i=>i.setSize),[e,n]=x.useState(!1),[r,o]=x.useState(a.width),[c,f]=x.useState(a.height),m=x.useCallback((i,l)=>{n(!0);try{s(i,l),p.resize({width:i,height:l})}finally{n(!1)}},[s]);return t.jsxs(t.Fragment,{children:[e&&t.jsx(M,{}),t.jsx(J,{children:t.jsxs(se,{sx:{display:"flex",flexDirection:"row",gap:1,width:"100%",alignItems:"center",justifyContent:"center"},children:[t.jsxs(d,{sx:{display:"flex",flexDirection:"column",gap:1},children:[t.jsxs(d,{sx:{display:"flex",flexDirection:"row",alignItems:"end",gap:1},children:[t.jsx(b,{children:"å½“å‰å®½åº¦:"}),t.jsx(P,{value:a.width,size:"small",variant:"standard",sx:{maxWidth:"60px"},disabled:!0}),t.jsx(b,{children:"æ–°å®½åº¦:"}),t.jsx(H,{initValue:r,onChange:o,size:"small",variant:"standard",sx:{maxWidth:"60px"},min:h.minSize,max:h.maxSize})]}),t.jsxs(d,{sx:{display:"flex",flexDirection:"row",alignItems:"end",gap:1},children:[" ",t.jsx(b,{children:"å½“å‰é«˜åº¦:"}),t.jsx(P,{value:a.height,size:"small",variant:"standard",sx:{maxWidth:"60px"},disabled:!0}),t.jsx(b,{children:"æ–°é«˜åº¦:"}),t.jsx(H,{initValue:c,onChange:f,size:"small",variant:"standard",sx:{maxWidth:"60px"},min:h.minSize,max:h.maxSize})]})]}),t.jsx(w,{sx:{aspectRatio:1,minWidth:0,padding:0,p:1},component:"label",onClick:()=>{m(r,c)},children:t.jsx(ae,{})})]})})]})}function ve(){const[a,s]=x.useState(!1),e=C(l=>l.hasOutput),n=g(l=>l.testConflict),r=g(l=>l.dontCareConflict),o=g(l=>l.setDontCareConflict),[c,f]=x.useState(!1),m=x.useCallback(l=>{s(!0);try{if(!l&&n()){f(!0);return}p.encode()}finally{s(!1)}},[n]),i=x.useRef(null);return x.useEffect(()=>(p.bind(i.current),()=>{p.unbind()}),[]),t.jsxs(d,{sx:{display:"flex",flexDirection:"column",gap:1},children:[a&&t.jsx(M,{}),t.jsx(U,{show:c,onClose:()=>{f(!1)},onConfirm:()=>{f(!1),m(!0)},showWarning:!r,setShowWarning:l=>{o(!l)},title:"è‰²é˜¶åŒºé—´å­˜åœ¨å†²çªï¼",content:["å»ºè®®é¿å…è¾“å…¥å›¾ç‰‡çš„è‰²é˜¶ç«¯ç‚¹ä¹‹é—´å‘ç”Ÿé‡å ï¼Œå¦åˆ™æ˜¾å½¢æ•ˆæœå¯èƒ½ä¸å¦‚é¢„æœŸã€‚","ä¾‹å¦‚ 0-24 ä¸ 12-36 å­˜åœ¨é‡å , å»ºè®®è°ƒæ•´ä¸º 0-24 ä¸ 25-49ã€‚"]}),t.jsx(w,{variant:"contained",onClick:()=>{m(!1)},fullWidth:!0,children:"å…‰æ£±ï¼Œå¯åŠ¨ï¼"}),!e&&t.jsx(_,{text:"åªæ˜¯ä¸€å¼ ç”»å¸ƒ",styles:{width:"100%",objectFit:"contain"}}),t.jsx("canvas",{ref:i,style:{maxWidth:"100%",maxHeight:"100%",display:e?"block":"none"}})]})}function je(){const a=g(u=>u.saveFormat),s=g(u=>u.setSaveFormat),e=A(u=>u.showWarning),n=A(u=>u.setShowWarning),[r,o]=x.useState(!1),c=Y(u=>u.setImages),f=O(u=>u.setCurrentRoute),[m,i]=x.useState(!1),l=x.useCallback((u,I)=>{if(!I&&u!=="JPEG"&&e){o(!0);return}i(!0),p.saveResult(u).then(S=>{Z(`å·²ä¿å­˜ä¸º ${S}`)}).catch(S=>{console.error("Failed to save result:",S),z("ä¿å­˜å¤±è´¥")}).finally(()=>{i(!1)})},[e]),j=x.useCallback(u=>{i(!0),(async()=>{const I=await p.encodeResultToFile(u),S=await $.fromFileData(I);c([S]),f(V.decode)})().catch(I=>{console.error("Failed to encode result:",I),z("è·³è½¬å¤±è´¥")}).finally(()=>{i(!1)})},[c,f]);return t.jsxs(d,{sx:{width:"100%",display:"flex",flexDirection:"row",gap:1},children:[t.jsx(U,{show:r,onClose:()=>{o(!1)},onConfirm:()=>{o(!1),l(a,!0)},showWarning:e,setShowWarning:n,title:`ç¡®è®¤ä¿å­˜ä¸º ${a}?`,content:["é JPEG æ ¼å¼å¯èƒ½ä¼šè¢«æŸäº›ç¤¾äº¤å¹³å°å¼ºåˆ¶å‹ç¼©ï¼Œè¿™å°†ä¸¥é‡å½±å“æ˜¾å½¢æ•ˆæœã€‚è¯·è°¨æ…é€‰æ‹©ã€‚"]}),t.jsx(w,{sx:{flex:1},variant:"contained",onClick:()=>{l(a,!1)},disabled:m,children:"ä¿å­˜ç»“æœ"}),t.jsx(w,{sx:{flex:1},variant:"contained",color:"secondary",onClick:()=>{j(a)},disabled:m,children:"æ˜¾å½¢æµ‹è¯•"}),t.jsx(ne,{format:a,onChange:u=>{s(u)},disabled:m}),t.jsx(y,{message:"é JPEG æ ¼å¼æœ‰è¾ƒé«˜çš„è¢«ç¤¾äº¤å¹³å°å¼ºåˆ¶å‹ç¼©çš„é£é™©"})]})}export{De as default};
