import{r as c,s as k,a as V,j as e,B as l,L as H,b as C,u as o,c as v,d as O,e as L,f as w,g as _,T as F,D as f,E as P,m as M,h as A}from"./index-CWZFb3Ri.js";import{P as N,I as $,D as U,L as I,a as q,n as E,b,c as G,C as J,d as B,H as z,S as R,N as S,e as K,M as x,F as Q}from"./number-input-BchOcwQt.js";function X({onLoad:n,children:t,defaultImage:s,disabled:r}){const[a,d]=c.useState(!1),h=c.useCallback(i=>{(async()=>{d(!0);const u=await i();if(u.length===0){k("没有图片被加载");return}const W=u.map(p=>new Promise(T=>{N.fromFileData(p).then(D=>{T(D)}).catch(D=>{console.error("Failed to load image:",D),T(null)})})),j=(await Promise.all(W)).filter(p=>p!==null);j.length!==0&&(V(`成功加载 ${j.length.toString()} 张图片`),n(j))})().catch(u=>{console.error("Failed to load image:",u),k("加载图片失败")}).finally(()=>{d(!1)})},[n]),m=()=>I.fromFileSelect(!0),g=i=>I.fromDropItems(i,!0);return e.jsxs(l,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:1,width:"100%"},children:[a&&e.jsx(H,{}),e.jsxs(l,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",gap:1,width:"100%"},children:[e.jsx(l,{sx:{flex:1},children:e.jsx($,{onconfirm:i=>{n([i])},label:"加载单张",disabled:a||r,defaultImage:s})}),e.jsx(l,{sx:{flex:1},children:e.jsx(C,{variant:"contained",color:"secondary",onClick:()=>{h(m)},fullWidth:!0,disabled:a||r,children:"加载多张"})})]}),e.jsx(U,{onDrop:i=>{h(()=>g(i))},disabled:a||r,children:t})]})}class Y extends q{decodedData=E();adjustedData=E();bind(t){super.bind(t),this.subscribe(o.subscribe(s=>s.lowerThreshold,()=>{this.decode()})),this.subscribe(o.subscribe(s=>s.higherThreshold,()=>{this.decode()})),this.subscribe(o.subscribe(s=>s.method,()=>{this.decode()})),this.subscribe(o.subscribe(s=>s.contrast,()=>{this.adjust(!0)})),this.subscribe(v.subscribe(s=>s.currImage,s=>{s?this.setImage(s.image):this.clearImage()},{fireImmediately:!0}))}setImage(t){super.setImage(t,!1),this.setPreset(t.metadata),this.decode(),this.adjust(),this.putImageData(this.adjustedData)}clearImage(){this.srcData.v=null,this.decodedData.v=null,this.adjustedData.v=null,this.clear()}setPreset(t){console.log("Setting preset from string:",t);const{lowerThreshold:s,higherThreshold:r,contrast:a}=o.getState(),d={lowerThreshold:s,higherThreshold:r,method:"black",contrast:a};b.decodePreset(t,d),this.setValues(d)}setValues(t){o.setState({lowerThreshold:t.lowerThreshold,higherThreshold:t.higherThreshold,contrast:t.contrast})}decode=()=>{if(!this.srcData.v){console.warn("No original image data to decode");return}if(G.matchSize(this.srcData,this.decodedData),!this.decodedData.v){console.warn("No buffer available");return}const{lowerThreshold:t,higherThreshold:s,method:r,contrast:a}=o.getState();b.prismDecode(this.srcData.v,this.decodedData.v,{lowerThreshold:t,higherThreshold:s,method:r,contrast:a}),this.adjust()};adjust(t){const{contrast:s}=o.getState();t||s!==0?b.adjustContrast(s,this.decodedData,this.adjustedData):this.adjustedData.v=this.decodedData.v,this.putImageData(this.adjustedData)}async saveCurrentImage(t){return this.saveImageFile(await this.encodeImageFile(this.adjustedData,t),t)}async saveOriginalImage(t){return this.saveImageFile(await this.encodeImageFile(this.srcData,t),t)}}const y=new Y;function ie(){const[n,t]=c.useState(!1),s=v(i=>i.setImages),r=O(i=>i.setShow),a=c.useCallback(i=>{s(i),i.length>1&&r(!0)},[s,r]),d=c.useCallback(()=>{t(!0),(async()=>{const i=await I.fromAssets(L.decode);if(i.length===0){w("加载默认图片失败");return}const u=await N.fromFileData(i[0]);s([u])})().catch(i=>{w("加载默认图片失败"),console.error("Failed to load default image:",i)}).finally(()=>{t(!1)})},[s]),h=c.useRef(null),m=v(i=>i.currImage);c.useEffect(()=>{if(h.current)return y.bind(h.current),()=>{y.unbind()}},[]);const g=_();return e.jsxs(e.Fragment,{children:[n&&e.jsx(H,{}),e.jsxs(l,{sx:{display:"flex",flexDirection:g?"row":"column",alignItems:"center",justifyContent:"center",maxWidth:g?"lg":"sm",gap:2,width:"100%",mx:"auto"},children:[e.jsxs(X,{onLoad:a,defaultImage:L.decode,disabled:n,children:[e.jsx("canvas",{ref:h,style:{width:"100%",height:"100%",display:m?"block":"none"}}),!m&&e.jsx(J,{text:n?"加载中...":"只是一张画布",action:"加载示例图片",onClick:d,disabled:n})]}),e.jsxs(l,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:2,width:"100%"},children:[e.jsxs(B,{children:[e.jsx(Z,{}),e.jsx(l,{sx:{mt:2}}),e.jsx(ee,{})]}),e.jsx(B,{children:e.jsx(se,{})}),e.jsx(te,{})]})]})]})}function Z(){const n=o(a=>a.lowerThreshold),t=o(a=>a.higherThreshold),s=o(a=>a.setLowerThreshold),r=o(a=>a.setHigherThreshold);return e.jsxs(l,{sx:{display:"flex",flexDirection:"column",px:2,width:"100%",textAlign:"center"},children:[e.jsxs(l,{sx:{display:"flex",flexDirection:"row",alignItems:"end",justifyContent:"center",gap:1,with:"100%"},children:[e.jsx(F,{variant:"subtitle1",children:"1. 阈值调整"}),e.jsx(z,{message:"大多数情况下只需要调整右端阈值"})]}),e.jsx(R,{value:[n,t],onChange:(a,d)=>{s(d[0]),r(d[1])},min:0,max:255,step:f.thresholdStep,valueLabelDisplay:"auto"}),e.jsxs(l,{sx:{display:"flex",flexDirection:"row",gap:1},children:[e.jsx(l,{sx:{flex:2}}),e.jsx(S,{realValue:n,onSubmit:a=>{s(a)},min:0,max:Math.max(t-1,0),step:f.thresholdStep,sx:{width:"100px"},variant:"standard"}),e.jsx(l,{sx:{flex:1}}),e.jsx(S,{realValue:t,onSubmit:a=>{r(a)},min:Math.max(n+1,1),max:255,step:f.thresholdStep,sx:{width:"100px"},variant:"standard"}),e.jsx(l,{sx:{flex:2}})]})]})}function ee(){const n=o(s=>s.contrast),t=o(s=>s.setContrast);return e.jsxs(l,{sx:{display:"flex",flexDirection:"column",px:2,width:"100%",textAlign:"center"},children:[e.jsx(l,{sx:{display:"flex",flexDirection:"row",alignItems:"center",gap:1,with:"100%",justifyContent:"center"},children:e.jsx(F,{variant:"subtitle1",children:"2. 对比度调整"})}),e.jsx(R,{value:n,onChange:(s,r)=>{t(r)},min:A,max:M,step:P.contrastStep,valueLabelDisplay:"auto"}),e.jsxs(l,{sx:{display:"flex",flexDirection:"row",gap:1},children:[e.jsx(l,{sx:{flex:2}}),e.jsx(S,{realValue:n,onSubmit:s=>{t(s)},min:A,max:M,step:P.contrastStep,sx:{width:"100px"},variant:"standard"}),e.jsx(l,{sx:{flex:1}}),e.jsx(C,{size:"small",onClick:()=>{t(f.contrast)},sx:{width:"100px"},children:"重置对比度"}),e.jsx(l,{sx:{flex:2}})]})]})}function se(){const n=o(s=>s.method),t=o(s=>s.setMethod);return e.jsxs(l,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",gap:1},children:[e.jsx(F,{variant:"subtitle1",children:"3. 其他像素处理方式:"}),e.jsxs(K,{value:n,size:"small",onChange:s=>{t(s.target.value)},children:[e.jsx(x,{value:"ltavg",children:"临近平均"}),e.jsx(x,{value:"lcopy",children:"左侧复制"}),e.jsx(x,{value:"tcopy",children:"上方复制"}),e.jsx(x,{value:"transparent",children:"置为透明"}),e.jsx(x,{value:"black",children:"置为黑色"}),e.jsx(x,{value:"white",children:"置为白色"})]}),e.jsx(z,{message:"此选项不会大幅影响显形质量"})]})}function te(){const n=o(r=>r.saveFormat),t=o(r=>r.setSaveFormat),s=c.useCallback(r=>{y.saveCurrentImage(r).then(a=>{V(`已保存为: ${a}`)}).catch(a=>{console.error("Failed to save image:",a),w("保存显示图像失败")})},[]);return e.jsxs(l,{sx:{width:"100%",display:"flex",flexDirection:"row",gap:1},children:[e.jsx(C,{sx:{flex:1},variant:"contained",onClick:()=>{s(n)},children:"保存显示图像"}),e.jsx(Q,{format:n,onChange:r=>{t(r)}})]})}export{ie as default};
