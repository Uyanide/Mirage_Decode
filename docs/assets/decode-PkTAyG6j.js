import{r as g,s as L,a as R,j as n,B as i,L as _,b as P,u as c,c as y,e as F,I as M,d as O,f as E,g as I,h as V,T as N}from"./index-Bl150xPo.js";import{P as A,I as $,D as U,L as C,n as z,a as B,H,S as W,b as S,c as J}from"./help-button-DcEIAC8i.js";import{I as T,P as q,s as G,C as K,M as f}from"./file-saver-B6zHcRF_.js";function Q({onLoad:s,children:t,defaultImage:e,disabled:r}){const[a,l]=g.useState(!1),d=g.useCallback(o=>{(async()=>{l(!0);const m=await o();if(m.length===0){L("没有图片被加载");return}const h=m.map(j=>new Promise(v=>{A.fromFileData(j).then(D=>{v(D)}).catch(D=>{console.error("加载图片失败:",D),v(null)})})),p=(await Promise.all(h)).filter(j=>j!==null);p.length!==0&&(R(`成功加载 ${p.length.toString()} 张图片`),s(p))})().catch(m=>{console.error("加载图片失败:",m),L("加载图片失败")}).finally(()=>{l(!1)})},[s]),u=()=>C.fromFileSelect(!0),x=o=>C.fromDropItems(o,!0);return n.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:1,width:"100%"},children:[a&&n.jsx(_,{}),n.jsxs(i,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",gap:1,width:"100%"},children:[n.jsx(i,{sx:{flex:1},children:n.jsx($,{onconfirm:o=>{s([o])},label:"加载单张",disabled:a||r,defaultImage:e})}),n.jsx(i,{sx:{flex:1},children:n.jsx(P,{variant:"contained",color:"secondary",onClick:()=>{d(u)},fullWidth:!0,disabled:a||r,children:"加载多张"})})]}),n.jsx(U,{onDrop:o=>{d(()=>x(o))},disabled:a||r,children:t})]})}const b={black:(s,t,e)=>{s[e]=0,s[e+1]=0,s[e+2]=0,s[e+3]=255},white:(s,t,e)=>{s[e]=255,s[e+1]=255,s[e+2]=255,s[e+3]=255},transparent:(s,t,e)=>{s[e]=0,s[e+1]=0,s[e+2]=0,s[e+3]=0},lcopy:(s,t,e)=>{if(e/4%t===0){b.black(s,t,e);return}s[e]=s[e-4],s[e+1]=s[e-3],s[e+2]=s[e-2],s[e+3]=s[e-1]},tcopy:(s,t,e)=>{const r=e-t*4;if(r<0){b.black(s,t,e);return}s[e]=s[r],s[e+1]=s[r+1],s[e+2]=s[r+2],s[e+3]=s[r+3]},ltavg:(s,t,e)=>{if(!e){b.black(s,t,e);return}const r=e-t*4;if(r<0){b.lcopy(s,t,e);return}if(e/4%t===0){b.tcopy(s,t,e);return}const a=e-4,l=e-t*4-4,d=(s[a]+s[r]+s[l])/3,u=(s[a+1]+s[r+1]+s[l+1])/3,x=(s[a+2]+s[r+2]+s[l+2])/3,o=(s[a+3]+s[r+3]+s[l+3])/3;s[e]=d,s[e+1]=u,s[e+2]=x,s[e+3]=o}};function X(s,t,{lowerThreshold:e,higherThreshold:r,method:a,grayConvert:l}){const d=s.data,u=t.data,x=255/(r-e),o=h=>Math.max(Math.min((h-e)*x,255),0),m=b[a];for(let h=0;h<d.length;h+=4){const w=d[h],p=d[h+1],j=d[h+2],v=(l??T.toGrayLum)(w,p,j),D=d[h+3];v>=e&&v<=r?(u[h]=o(w),u[h+1]=o(p),u[h+2]=o(j),u[h+3]=D):m(u,s.width,h)}}function Y(s,t){if(s.length<0)return!1;const e=s[0]==="1";if(s.length<3)return;const r=parseInt(s.slice(1,3),16);if(isNaN(r)||(e?(t.lowerThreshold=255-r,t.higherThreshold=255):(t.lowerThreshold=0,t.higherThreshold=r),s.length<5))return;const a=parseInt(s.slice(3,5),16);isNaN(a)||a<0||a>100||(t.contrast=100-a)}class Z extends q{decodedData=z();adjustedData=z();bind(t){super.bind(t),this.subscribe(c.subscribe(e=>e.lowerThreshold,()=>{this.decode()})),this.subscribe(c.subscribe(e=>e.higherThreshold,()=>{this.decode()})),this.subscribe(c.subscribe(e=>e.method,()=>{this.decode()})),this.subscribe(c.subscribe(e=>e.contrast,()=>{this.adjust(!0)})),this.subscribe(y.subscribe(e=>e.currImage,e=>{e?this.setImage(e.image):this.clear()},{fireImmediately:!0}))}setImage(t){super.setImage(t,!1),this.setPreset(t.metadata),this.decode(),this.adjust(),this.putImageData(this.adjustedData)}setPreset(t){console.log("Setting preset from string:",t);const{lowerThreshold:e,higherThreshold:r,contrast:a}=c.getState(),l={lowerThreshold:e,higherThreshold:r,method:"black",contrast:a};Y(t,l),this.setValues(l)}setValues(t){c.setState({lowerThreshold:t.lowerThreshold,higherThreshold:t.higherThreshold,contrast:t.contrast})}decode=()=>{if(!this.srcData.v){console.warn("No original image data to decode");return}if(T.matchSize(this.srcData,this.decodedData),!this.decodedData.v){console.warn("No buffer available");return}const{lowerThreshold:t,higherThreshold:e,method:r,contrast:a}=c.getState();X(this.srcData.v,this.decodedData.v,{lowerThreshold:t,higherThreshold:e,method:r}),this.adjust()};adjust(t){const{contrast:e}=c.getState();t||e!==50?T.adjustContrast(e,this.decodedData,this.adjustedData):this.adjustedData.v=this.decodedData.v,this.putImageData(this.adjustedData)}async saveCurrentImage(t){const e=this.adjustedData.v??this.decodedData.v??this.srcData.v;if(!e)throw new Error("No image data available to save");const r=await F(e,t);return G(r,M[t])}async saveOriginalImage(t){if(!this.srcData.v)throw new Error("No original image data available to save");const e=await F(this.srcData.v,t);return G(e,M[t])}}const k=new Z;function le(){const[s,t]=g.useState(!1),e=y(o=>o.setImages),r=O(o=>o.setShow),a=g.useCallback(o=>{e(o),o.length>1&&r(!0)},[e,r]),l=g.useCallback(()=>{t(!0),(async()=>{const o=await C.fromAssets(E.decode);if(o.length===0){I("加载默认图片失败");return}const m=await A.fromFileData(o[0]);e([m])})().catch(o=>{I("加载默认图片失败"),console.error("加载默认图片失败:",o)}).finally(()=>{t(!1)})},[e]),d=g.useRef(null),u=y(o=>o.currImage);g.useEffect(()=>{if(d.current)return k.bind(d.current),()=>{k.unbind()}},[]);const x=V();return n.jsxs(n.Fragment,{children:[s&&n.jsx(_,{}),n.jsxs(i,{sx:{display:"flex",flexDirection:x?"row":"column",alignItems:"center",justifyContent:"center",maxWidth:x?"lg":"sm",gap:2,width:"100%",mx:"auto"},children:[n.jsxs(Q,{onLoad:a,defaultImage:E.decode,disabled:s,children:[n.jsx("canvas",{ref:d,style:{width:"100%",height:"100%",display:u?"block":"none"}}),!u&&n.jsx(K,{text:s?"加载中...":"只是一张画布",action:"加载示例图片",onClick:l,disabled:s})]}),n.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:2,width:"100%"},children:[n.jsxs(B,{children:[n.jsx(ee,{}),n.jsx(i,{sx:{mt:2}}),n.jsx(se,{})]}),n.jsx(B,{children:n.jsx(te,{})}),n.jsx(ne,{})]})]})]})}function ee(){const s=c(a=>a.lowerThreshold),t=c(a=>a.higherThreshold),e=c(a=>a.setLowerThreshold),r=c(a=>a.setHigherThreshold);return n.jsxs(i,{sx:{display:"flex",flexDirection:"column",px:2,width:"100%",textAlign:"center"},children:[n.jsxs(i,{sx:{display:"flex",flexDirection:"row",alignItems:"end",justifyContent:"center",gap:1,with:"100%"},children:[n.jsx(N,{variant:"subtitle1",children:"1. 阈值调整"}),n.jsx(H,{message:"大多数情况下只需要调整右端阈值"})]}),n.jsx(W,{value:[s,t],onChange:(a,l)=>{e(l[0]),r(l[1])},min:0,max:255,step:1,valueLabelDisplay:"auto"}),n.jsxs(i,{sx:{display:"flex",flexDirection:"row",gap:1},children:[n.jsx(i,{sx:{flex:2}}),n.jsx(S,{value:s,size:"small",onChange:a=>{const l=Number(a.target.value);isNaN(l)||e(l)},inputProps:{step:1,min:0,max:255,type:"number"},sx:{width:"100px"}}),n.jsx(i,{sx:{flex:1}}),n.jsx(S,{value:t,size:"small",onChange:a=>{const l=Number(a.target.value);isNaN(l)||r(l)},inputProps:{step:1,min:0,max:255,type:"number"},sx:{width:"100px"}}),n.jsx(i,{sx:{flex:2}})]})]})}function se(){const s=c(e=>e.contrast),t=c(e=>e.setContrast);return n.jsxs(i,{sx:{display:"flex",flexDirection:"column",px:2,width:"100%",textAlign:"center"},children:[n.jsx(i,{sx:{display:"flex",flexDirection:"row",alignItems:"center",gap:1,with:"100%",justifyContent:"center"},children:n.jsx(N,{variant:"subtitle1",children:"2. 对比度调整"})}),n.jsx(W,{value:s,onChange:(e,r)=>{t(r)},min:0,max:100,step:1,valueLabelDisplay:"auto"}),n.jsxs(i,{sx:{display:"flex",flexDirection:"row",gap:1},children:[n.jsx(i,{sx:{flex:2}}),n.jsx(S,{value:s,size:"small",onChange:e=>{const r=Number(e.target.value);isNaN(r)||t(r)},inputProps:{step:1,min:0,max:255,type:"number"},sx:{width:"100px"}}),n.jsx(i,{sx:{flex:1}}),n.jsx(P,{size:"small",onClick:()=>{t(50)},sx:{width:"100px"},children:"重置对比度"}),n.jsx(i,{sx:{flex:2}})]})]})}function te(){const s=c(e=>e.method),t=c(e=>e.setMethod);return n.jsxs(i,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",gap:1},children:[n.jsx(N,{variant:"subtitle1",children:"3. 其他像素处理方式:"}),n.jsxs(J,{value:s,size:"small",onChange:e=>{t(e.target.value)},children:[n.jsx(f,{value:"ltavg",children:"临近平均"}),n.jsx(f,{value:"lcopy",children:"左侧复制"}),n.jsx(f,{value:"tcopy",children:"上方复制"}),n.jsx(f,{value:"transparent",children:"置为透明"}),n.jsx(f,{value:"black",children:"置为黑色"}),n.jsx(f,{value:"white",children:"置为白色"})]}),n.jsx(H,{message:"此选项不会大幅影响显形质量"})]})}function ne(){const s=c(r=>r.saveFormat),t=c(r=>r.setSaveFormat),e=g.useCallback(r=>{k.saveCurrentImage(r).then(a=>{R(`已保存为: ${a}`)}).catch(a=>{console.error("Failed to save image:",a),I("保存显示图像失败")})},[]);return n.jsxs(i,{sx:{width:"100%",display:"flex",flexDirection:"row",gap:1},children:[n.jsx(P,{sx:{flex:1},variant:"contained",onClick:()=>{e(s)},children:"保存显示图像"}),n.jsxs(J,{value:s,variant:"standard",onChange:r=>{t(r.target.value)},sx:{minWidth:80},children:[n.jsx(f,{value:"JPEG",children:"JPEG"}),n.jsx(f,{value:"PNG",children:"PNG"})]})]})}export{le as default};
